# 데이터베이스 샤딩 학습 자료

## 1. 샤딩이란?

샤딩(sharding)은 데이터베이스의 데이터를 여러 물리적 데이터베이스 서버(샤드)에 나누어 저장하는 기술입니다. 마치 커다란 퍼즐을 여러 조각으로 나누어 각기 다른 상자에 보관하는 것과 비슷합니다. 각 샤드는 독립적인 데이터베이스처럼 작동하며, 전체 데이터의 일부만 저장합니다.

### 비유
- 이커머스 프로젝트에서 모든 사용자 데이터를 한 서버에 저장하면 부하가 커집니다. 샤딩은 사용자 데이터를 지역별로 나누어(예: 한국 사용자, 미국 사용자), 각 지역 데이터를 별도 서버에 저장하는 방식입니다.
- 예: `users` 테이블을 사용자 ID의 해시값으로 4개의 샤드에 나누어 저장.

### 샤딩의 목적
- **확장성**: 단일 서버의 용량 한계를 넘어 데이터와 부하를 분산.
- **성능 향상**: 각 샤드가 독립적으로 쿼리를 처리하여 속도 개선.
- **고가용성**: 한 샤드가 실패해도 다른 샤드는 계속 작동.

---

## 2. 샤딩의 주요 유형

샤딩은 데이터를 나누는 기준(샤드 키)에 따라 여러 방식으로 구현됩니다.

### 2.1. 해시 샤딩 (Hash Sharding)
- 샤드 키(예: `user_id`)의 해시값을 기준으로 데이터를 분배.
- **예시**: `users` 테이블을 `id`의 해시값으로 4개 샤드에 나눔.
  ```sql
  -- 샤드 1: WHERE HASH(id) % 4 = 0
  -- 샤드 2: WHERE HASH(id) % 4 = 1
  ```
- **장점**: 데이터가 균등하게 분배되어 부하 균형 유지.
- **단점**: 범위 쿼리(예: `id BETWEEN 1000 AND 2000`)가 어려움.

### 2.2. 범위 샤딩 (Range Sharding)
- 샤드 키의 값 범위로 데이터를 나눔.
- **예시**: `orders` 테이블을 `user_id` 범위로 나눔(예: 1~1000000은 샤드 1, 1000001~2000000은 샤드 2).
- **장점**: 범위 기반 쿼리 처리 용이.
- **단점**: 데이터 분포가 불균등할 경우 특정 샤드에 부하 집중.

### 2.3. 지리적 샤딩 (Geo Sharding)
- 지역 또는 위치를 기준으로 데이터를 나눔.
- **예시**: `users` 테이블을 `country_code`로 나누어 한국 사용자 데이터는 한국 샤드, 미국 사용자 데이터는 미국 샤드에 저장.
- **장점**: 지역별 데이터 접근 속도 향상.
- **단점**: 지역 간 데이터 조인이 복잡.

---

## 3. 샤딩의 장점

1. **수평 확장성**:
   - 서버를 추가하여 데이터와 부하를 분산.
   - 예: `users` 테이블이 너무 커지면 새 샤드를 추가하여 부하 분산.

2. **성능 향상**:
   - 각 샤드가 독립적으로 쿼리를 처리하므로 응답 시간 단축.
   - 예: 특정 사용자의 주문 조회 시 해당 샤드만 스캔.

3. **장애 격리**:
   - 한 샤드가 다운되어도 다른 샤드는 정상 작동.
   - 예: 한국 샤드 장애 시 미국 샤드는 계속 서비스 제공.

---

## 4. 샤딩의 단점

1. **복잡성 증가**:
   - 샤드 간 데이터 분배와 쿼리 라우팅을 관리해야 함.
   - 애플리케이션 또는 미들웨어(예: Vitess, ProxySQL)가 샤드 선택 로직 필요.

2. **조인 어려움**:
   - 샤드 간 데이터 조인(예: `users`와 `orders` 조인)이 복잡하거나 불가능.
   - 해결책: 애플리케이션 레벨에서 조인 처리 또는 반정규화.

3. **데이터 불균형**:
   - 샤드 키 선택이 잘못되면 특정 샤드에 데이터가 집중.
   - 예: 특정 지역의 사용자 데이터가 많아지면 해당 샤드에 부하 집중.

---

## 5. 이커머스 프로젝트에서의 적용 예시

### `users` 테이블 샤딩
- **상황**: 이커머스 플랫폼에 수백만 사용자가 등록되어 단일 서버의 성능 한계 도달.
- **적용**:
  - 샤드 키: `user_id`의 해시값.
  - 4개 샤드에 데이터 분배: `HASH(user_id) % 4`.
  - 예: `user_id = 123`은 샤드 2에 저장.
- **효과**:
  - 사용자 조회 속도 향상: 특정 사용자의 데이터는 해당 샤드에서만 검색.
  - 서버 추가로 확장 가능: 새 샤드 추가 시 데이터 재분배.

### `orders` 테이블 샤딩
- **상황**: 주문 데이터가 급증하여 조회 및 쓰기 성능 저하.
- **적용**:
  - 샤드 키: `user_id`(사용자별 주문은 동일 샤드에 저장).
  - 예: `user_id`가 같은 샤드에 `orders`와 `order_items` 저장.
- **효과**:
  - 사용자별 주문 조회 시 단일 샤드만 스캔.
  - 반정규화(`orders.user_name`)와 결합 시 조인 최소화.

---

## 6. 샤딩 구현 시 고려사항

1. **샤드 키 선택**:
   - 자주 조회되는 컬럼(예: `user_id`, `order_id`)을 선택.
   - 데이터 분포를 균등하게 유지할 수 있는 키(예: 해시 기반 `user_id`).

2. **데이터 재분배**:
   - 새 샤드 추가 시 기존 데이터를 재분배해야 함.
   - 예: `HASH(user_id) % 4`에서 `HASH(user_id) % 5`로 변경 시 데이터 마이그레이션 필요.

3. **쿼리 라우팅**:
   - 애플리케이션이 샤드 키를 기준으로 올바른 샤드에 쿼리를 보내도록 설계.
   - 예: `SELECT * FROM users WHERE id = 123`은 `HASH(123) % 4`로 샤드 2로 라우팅.

4. **백업 및 복구**:
   - 각 샤드를 독립적으로 백업/복구 가능하도록 설계.
   - 예: 샤드별 백업 스크립트 작성.

---

## 7. 파티셔닝과의 차이점

- **파티셔닝**:
  - 단일 데이터베이스 내에서 테이블을 논리적 조각으로 나눔.
  - 예: `event_logs`를 월별 파티션으로 나눔.
  - 단일 서버에서 관리, 관리 간단.

- **샤딩**:
  - 데이터를 여러 물리적 서버(샤드)에 나눔.
  - 예: `users`를 지역별로 다른 서버에 저장.
  - 복잡하지만 확장성 뛰어남.

### 이커머스에서의 선택 기준
- 데이터 크기가 작고 단일 서버로 충분하면 **파티셔닝** 사용(예: `event_logs`).
- 사용자/주문 데이터가 수백만 행 이상이고 서버 확장이 필요하면 **샤딩** 고려(예: `users`, `orders`).

---

## 8. 학습자 팁

- **시작하기**: MySQL 또는 MongoDB에서 샤딩 설정을 실습(예: `user_id`로 샤딩).
- **실습 예제**: `users` 테이블을 해시 샤딩으로 나누고, 특정 사용자의 데이터를 조회하는 쿼리 작성.
- **도구**: MongoDB의 샤딩 설정 또는 MySQL의 Vitess로 샤딩 실습.
- **주의**: 샤드 키 선택 시 데이터 분포를 분석(예: `user_id`의 해시값 분포 확인).

---

## 9. 요약

샤딩은 대규모 이커머스 시스템에서 데이터와 부하를 여러 서버에 분산하여 확장성과 성능을 높이는 기술입니다. 샤드 키 선택과 쿼리 라우팅이 핵심이며, `users`나 `orders` 같은 테이블에 적용하면 효과적입니다. 초보자는 간단한 해시 샤딩부터 실습하고, 데이터 분포와 쿼리 패턴을 분석하여 샤딩 전략을 최적화하세요.