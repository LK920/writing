# Java/Spring 동시성 테스트 도구 총정리

> 동시성(Concurrent) 테스트를 할 때 쓸 수 있는 도구, 라이브러리, 패턴, 외부툴을 용도별로 정리. 각 도구별로 사용처, 목적, 특징, 실무 팁을 포함.

---

## 1. JVM/Java 표준 동시성 도구

### 1) ExecutorService
- **사용처**: 단위/통합테스트, 멀티스레드 코드 테스트
- **용도/목적**: 여러 작업을 스레드풀에서 동시에 실행
- **예시**:
    ```java
    ExecutorService executor = Executors.newFixedThreadPool(10);
    executor.submit(() -> { /* 동시 작업 */ });
    executor.shutdown();
    ```
- **팁**: 테스트에서 여러 스레드로 동시에 요청 보내기

### 2) CountDownLatch
- **사용처**: 단위/통합테스트, 동시 시작/종료 제어
- **용도/목적**: 여러 스레드가 동시에 시작/끝나도록 동기화
- **예시**:
    ```java
    CountDownLatch startLatch = new CountDownLatch(1);
    CountDownLatch doneLatch = new CountDownLatch(N);
    for (...) {
        new Thread(() -> {
            startLatch.await(); // 동시에 시작
            // ...
            doneLatch.countDown();
        }).start();
    }
    startLatch.countDown(); // 모든 스레드 동시 시작
    doneLatch.await(); // 모두 끝날 때까지 대기
    ```
- **팁**: 동시성 테스트의 기본 패턴

### 3) CyclicBarrier
- **사용처**: 단위/통합테스트, N개 스레드가 모두 특정 지점에 도달할 때까지 대기
- **용도/목적**: 여러 스레드가 동시에 어떤 작업을 시작하게 만들 때
- **예시**:
    ```java
    CyclicBarrier barrier = new CyclicBarrier(N);
    for (...) {
        new Thread(() -> {
            barrier.await(); // 모두 모이면 동시에 진행
            // ...
        }).start();
    }
    ```
- **팁**: CountDownLatch와 비슷하지만, 재사용 가능

### 4) CompletableFuture
- **사용처**: 비동기/논블로킹 동시성 테스트, 단위/통합
- **용도/목적**: 비동기 작업을 조합, 여러 Future를 동시에 실행/합치기
- **예시**:
    ```java
    CompletableFuture<Void> f1 = CompletableFuture.runAsync(() -> ...);
    CompletableFuture<Void> f2 = CompletableFuture.runAsync(() -> ...);
    CompletableFuture.allOf(f1, f2).join();
    ```
- **팁**: 비동기 API, 논블로킹 서비스 테스트에 유용

### 5) ThreadPoolExecutor
- **사용처**: 대량 동시 작업, 커스텀 스레드풀
- **용도/목적**: 스레드풀 파라미터(큐, 정책 등) 세밀 제어
- **예시**:
    ```java
    ThreadPoolExecutor pool = new ThreadPoolExecutor(10, 20, ...);
    ```
- **팁**: 대규모 부하/동시성 실험에 적합

---

## 2. Spring/Spring Boot 환경

### 1) MockMvc (Spring Test)
- **사용처**: 통합테스트(컨트롤러, API)
- **용도/목적**: 실제 HTTP 없이 컨트롤러/필터/서비스까지 end-to-end 테스트
- **예시**:
    ```java
    mockMvc.perform(patch("/point/1/charge").content(...))
    ```
- **팁**: 여러 스레드에서 동시에 호출하면 동시성 검증 가능

### 2) @Async + @EnableAsync
- **사용처**: 비동기 서비스, 이벤트, 백그라운드 작업 테스트
- **용도/목적**: Spring의 비동기 실행 지원
- **예시**:
    ```java
    @Async
    public void asyncMethod() { ... }
    ```
- **팁**: 실제 비동기 동작/경합 상황 테스트에 활용

### 3) Awaitility
- **사용처**: 비동기/지연/폴링 테스트
- **용도/목적**: 일정 조건이 만족될 때까지 기다리며 검증
- **예시**:
    ```java
    Awaitility.await().atMost(2, TimeUnit.SECONDS)
        .untilAsserted(() -> assertThat(...));
    ```
- **팁**: 비동기 결과, 이벤트, 상태 변화 테스트에 강력

### 4) TestContainers
- **사용처**: 실제 DB/외부 시스템과 통합 동시성 테스트
- **용도/목적**: Docker 컨테이너로 실제 환경 시뮬레이션
- **예시**:
    ```java
    @Container
    static PostgreSQLContainer<?> db = new PostgreSQLContainer<>(...);
    ```
- **팁**: DB Lock, 트랜잭션, 분산 환경 동시성 검증에 유용

---

## 3. 외부 부하/동시성 테스트 도구

### 1) JMeter
- **사용처**: 시스템/성능/부하/동시성 테스트(HTTP, DB 등)
- **용도/목적**: GUI로 대량 동시 요청, 시나리오, 응답시간 측정
- **특징**: 오픈소스, 스크립트/GUI 지원, 리포트 제공
- **팁**: 실서비스 수준의 대량 동시 요청, 부하테스트에 표준

### 2) k6
- **사용처**: 시스템/성능/부하/동시성 테스트(HTTP, WebSocket 등)
- **용도/목적**: 코드(js)로 시나리오 작성, CI/CD 연동
- **특징**: 코드 기반, CLI, 클라우드 연동, 리포트
- **팁**: DevOps/CI 환경에서 자동화 부하테스트에 강력

### 3) Gatling
- **사용처**: 시스템/성능/부하/동시성 테스트(HTTP 등)
- **용도/목적**: Scala/Java 기반, 코드로 시나리오 작성
- **특징**: 코드 기반, 고성능, 리포트
- **팁**: 복잡한 시나리오, 대규모 부하에 적합

### 4) Locust
- **사용처**: 시스템/성능/부하/동시성 테스트(HTTP 등)
- **용도/목적**: Python 코드로 시나리오 작성
- **특징**: 코드 기반, 웹 UI, 분산 실행
- **팁**: Python 친화적 환경, 분산 부하테스트에 유용

---

## 4. 기타/실무 팁

- **Thread.sleep()**: 테스트에서 요청 간 간격 조절(실제 동시성은 아님)
- **@TestPropertySource**: 테스트 환경에서 Rate Limit 등 파라미터 조정
- **JVM Thread Dump/Deadlock Detector**: 교착상태/스레드 상태 실시간 분석
- **Custom Barrier/Signal**: 복잡한 동기화 시 직접 구현
- **Spring WebTestClient**: WebFlux/Reactive 환경 동시성 테스트
- **JUnit5 @RepeatedTest**: 반복 실행으로 경합 상황 유도

---

## 5. 도구 선택 가이드

- **단위/통합 동시성 검증**: ExecutorService, CountDownLatch, MockMvc, Awaitility
- **비동기/이벤트/논블로킹**: CompletableFuture, Awaitility, @Async
- **실제 DB/외부 연동**: TestContainers
- **시스템/성능/대량 부하**: JMeter, k6, Gatling, Locust
- **실무/CI/CD**: k6, JMeter, TestContainers, Awaitility

---

## 6. 참고 키워드/문서
- Java Concurrency, Spring @Async, Awaitility, TestContainers, JMeter, k6, Gatling, Locust, ThreadPool, CountDownLatch, CompletableFuture, CyclicBarrier, MockMvc, WebTestClient, Deadlock, Race Condition, 부하테스트, 동시성 테스트

---

> 실무에서는 여러 도구/패턴을 조합해서 사용하는 것이 일반적입니다. 목적(단위/통합/시스템/성능)에 따라 적합한 도구를 선택하세요! 