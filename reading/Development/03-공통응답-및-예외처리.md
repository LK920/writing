# ê³µí†µ ì‘ë‹µ ì²˜ë¦¬ ë° ì˜ˆì™¸ ì²˜ë¦¬ ê°€ì´ë“œ

## ğŸ“‹ ëª©ì°¨
1. CommonResponse ì„¤ê³„ ì§„í™”
2. ì‘ë‹µ ì²˜ë¦¬ ì•„í‚¤í…ì²˜
3. ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬
4. HTTP ìƒíƒœ ì½”ë“œ ì „ëµ
5. ì‹¤ì œ êµ¬í˜„ ì˜ˆì‹œ

---

## CommonResponse ì„¤ê³„ ì§„í™”

### ğŸ”„ ì„¤ê³„ ë³€ì²œì‚¬

#### 1ë‹¨ê³„: ì´ì¤‘ ë˜í•‘ êµ¬ì¡° (ì´ˆê¸°)
```java
// âŒ ë¬¸ì œê°€ ìˆë˜ ì´ˆê¸° êµ¬ì¡°
public ResponseEntity<CommonResponse<T>> someMethod() {
    return ResponseEntity.ok(CommonResponse.success(data));
}

// ê²°ê³¼: ResponseEntity(CommonResponse(data)) - ì´ì¤‘ ë˜í•‘
```

#### 2ë‹¨ê³„: CommonResponse í†µí•© êµ¬ì¡°
```java
// âŒ ì—¬ì „íˆ ë³µì¡í•œ êµ¬ì¡°
@RestControllerAdvice
public class CommonResponse<T> implements ResponseBodyAdvice<Object> {
    // ì‘ë‹µ ë˜í•‘ + ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ëª¨ë‘ ë‹´ë‹¹
}
```

#### 3ë‹¨ê³„: ì—­í•  ë¶„ë¦¬ êµ¬ì¡° (ìµœì¢…) âœ…
```java
// âœ… ê°ê°ì˜ ì±…ì„ì„ ëª…í™•íˆ ë¶„ë¦¬
1. CommonResponse.java        - ì‘ë‹µ ë°ì´í„° êµ¬ì¡°
2. SuccessResponseAdvice.java - ì„±ê³µ ì‘ë‹µ ë˜í•‘
3. GlobalExceptionHandler.java - ì˜ˆì™¸ ì²˜ë¦¬
```

### ğŸ“Š ìµœì¢… CommonResponse êµ¬ì¡°
```java
/**
 * API ì‘ë‹µì˜ í‘œì¤€í™”ëœ ë˜í¼ í´ë˜ìŠ¤
 * 
 * ì‘ë‹µ í˜•íƒœ:
 * {
 *   "success": true/false,
 *   "message": "ì„±ê³µ/ì‹¤íŒ¨ ë©”ì‹œì§€",
 *   "data": ì‹¤ì œ ì‘ë‹µ ë°ì´í„° (ì„±ê³µ ì‹œì—ë§Œ),
 *   "timestamp": "2024-01-01T12:00:00"
 * }
 */
public class CommonResponse<T> {
    private boolean success;      // ìš”ì²­ ì„±ê³µ ì—¬ë¶€
    private String message;       // ì‘ë‹µ ë©”ì‹œì§€
    private T data;              // ì‹¤ì œ ì‘ë‹µ ë°ì´í„°
    private LocalDateTime timestamp; // ì‘ë‹µ ìƒì„± ì‹œê°„

    // ì •ì  íŒ©í† ë¦¬ ë©”ì„œë“œ
    public static <T> CommonResponse<T> success(T data) { ... }
    public static CommonResponse<Void> success() { ... }
    public static <T> CommonResponse<T> failure(String message) { ... }
}
```

---

## ì‘ë‹µ ì²˜ë¦¬ ì•„í‚¤í…ì²˜

### ğŸ—ï¸ 3ê³„ì¸µ ë¶„ë¦¬ ì•„í‚¤í…ì²˜

#### 1. CommonResponse (ë°ì´í„° êµ¬ì¡°)
- **ì—­í• **: ì‘ë‹µ ë°ì´í„° êµ¬ì¡° ì •ì˜
- **ì±…ì„**: ì„±ê³µ/ì‹¤íŒ¨ ì‘ë‹µ ëª¨ë¸ ì œê³µ
- **ìœ„ì¹˜**: ìˆœìˆ˜í•œ ë°ì´í„° í´ë˜ìŠ¤

#### 2. SuccessResponseAdvice (ì„±ê³µ ì‘ë‹µ ì²˜ë¦¬)
```java
/**
 * ì„±ê³µ ì‘ë‹µ ìë™ ë˜í•‘ í´ë˜ìŠ¤
 * 
 * ë™ì‘ ê³¼ì •:
 * 1. ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ UserDto ë°˜í™˜
 * 2. SuccessResponseAdviceê°€ ê°œì…
 * 3. CommonResponse.success(UserDto)ë¡œ ë˜í•‘
 * 4. í´ë¼ì´ì–¸íŠ¸ëŠ” í‘œì¤€í™”ëœ ì‘ë‹µ ë°›ìŒ
 */
@RestControllerAdvice(basePackages = "kr.hhplus.be.server.api.controller")
public class SuccessResponseAdvice implements ResponseBodyAdvice<Object> {

    @Override
    public boolean supports(MethodParameter returnType, Class converterType) {
        // ResponseEntityë¥¼ ë°˜í™˜í•˜ëŠ” ì˜ˆì™¸ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ëŠ” ì œì™¸
        return !returnType.getParameterType().equals(ResponseEntity.class);
    }

    @Override
    public Object beforeBodyWrite(Object body, MethodParameter returnType, ...) {
        if (returnType.getParameterType() == void.class) {
            return CommonResponse.success(); // void ë©”ì„œë“œìš©
        }
        return CommonResponse.success(body); // ë°ì´í„° ìˆëŠ” ê²½ìš°
    }
}
```

#### 3. GlobalExceptionHandler (ì˜ˆì™¸ ì²˜ë¦¬)
```java
/**
 * ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬ í´ë˜ìŠ¤
 * 
 * ì²˜ë¦¬ ê³¼ì •:
 * 1. ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì˜ˆì™¸ ë°œìƒ
 * 2. GlobalExceptionHandlerê°€ ìºì¹˜
 * 3. ì˜ˆì™¸ íƒ€ì…ì— ë”°ë¥¸ HTTP ìƒíƒœ ì½”ë“œ ê²°ì •
 * 4. CommonResponse.failure()ë¡œ í‘œì¤€í™”ëœ ì˜¤ë¥˜ ì‘ë‹µ ìƒì„±
 */
@RestControllerAdvice(basePackages = "kr.hhplus.be.server.api.controller")
public class GlobalExceptionHandler {
    // ì˜ˆì™¸ë³„ ì²˜ë¦¬ ë¡œì§
}
```

### ğŸ”„ ì „ì²´ í”Œë¡œìš°
```
Controller ë©”ì„œë“œ ì‹¤í–‰
         â†“
    ì„±ê³µ ì‹œ: SuccessResponseAdvice â†’ CommonResponse.success()
         â†“
    ì˜ˆì™¸ ì‹œ: GlobalExceptionHandler â†’ CommonResponse.failure()
         â†“
    í´ë¼ì´ì–¸íŠ¸ì—ê²Œ í‘œì¤€í™”ëœ ì‘ë‹µ ì „ë‹¬
```

---

## ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬

### ğŸ¯ ì˜ˆì™¸ ì²˜ë¦¬ ì „ëµ

#### 1. ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸ ì²˜ë¦¬
```java
@ExceptionHandler({
    BalanceException.class, 
    CouponException.class, 
    OrderException.class, 
    PaymentException.class, 
    ProductException.class
})
public ResponseEntity<CommonResponse<Object>> handleBusinessException(RuntimeException ex) {
    HttpStatus status = getStatusFromException(ex);
    return ResponseEntity.status(status).body(CommonResponse.failure(ex.getMessage()));
}
```

#### 2. ì…ë ¥ê°’ ê²€ì¦ ì‹¤íŒ¨ ì²˜ë¦¬
```java
@ExceptionHandler(MethodArgumentNotValidException.class)
public ResponseEntity<CommonResponse<Object>> handleValidationExceptions(
    MethodArgumentNotValidException ex) {
    
    String errorMessage = ex.getBindingResult()
        .getAllErrors()
        .get(0)
        .getDefaultMessage();
    
    return ResponseEntity
        .status(HttpStatus.BAD_REQUEST)
        .body(CommonResponse.failure(errorMessage));
}
```

#### 3. ì˜ˆìƒì¹˜ ëª»í•œ ì˜ˆì™¸ ì²˜ë¦¬ (ìµœí›„ì˜ ë³´ë£¨)
```java
@ExceptionHandler(Exception.class)
public ResponseEntity<CommonResponse<Object>> handleAllUncaughtException(Exception ex) {
    return ResponseEntity
        .status(HttpStatus.INTERNAL_SERVER_ERROR)
        .body(CommonResponse.failure("ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
}
```

### ğŸ·ï¸ ë„ë©”ì¸ë³„ ì˜ˆì™¸ í´ë˜ìŠ¤ ì„¤ê³„
```java
public class BalanceException extends RuntimeException {
    public static class Insufficient extends BalanceException {
        public Insufficient() { super("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤."); }
    }
    
    public static class ConcurrencyConflict extends BalanceException {
        public ConcurrencyConflict() { super("ì”ì•¡ ì²˜ë¦¬ ì¤‘ ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    }
}

public class ProductException extends RuntimeException {
    public static class NotFound extends ProductException {
        public NotFound() { super("ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
    }
    
    public static class OutOfStock extends ProductException {
        public OutOfStock() { super("ìƒí’ˆ ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); }
    }
}
```

---

## HTTP ìƒíƒœ ì½”ë“œ ì „ëµ

### ğŸ“Š ìƒíƒœ ì½”ë“œ ë§¤í•‘ ì „ëµ
```java
private HttpStatus getStatusFromException(RuntimeException ex) {
    // ì”ì•¡ ë¶€ì¡± ê´€ë ¨ â†’ 402 Payment Required
    if (ex instanceof BalanceException.Insufficient || 
        ex instanceof PaymentException.InsufficientBalance) 
        return HttpStatus.PAYMENT_REQUIRED;
    
    // ì¿ í° ë§Œë£Œ/ì†Œì§„ â†’ 410 Gone (ë” ì´ìƒ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ)
    if (ex instanceof CouponException.Expired || 
        ex instanceof CouponException.OutOfStock) 
        return HttpStatus.GONE;
    
    // ê¶Œí•œ ì—†ìŒ â†’ 403 Forbidden
    if (ex instanceof OrderException.Unauthorized) 
        return HttpStatus.FORBIDDEN;
    
    // ë¦¬ì†ŒìŠ¤ ì—†ìŒ â†’ 404 Not Found
    if (ex instanceof ProductException.NotFound || 
        ex instanceof OrderException.NotFound) 
        return HttpStatus.NOT_FOUND;
    
    // ë™ì‹œì„± ì¶©ëŒ, ì¬ê³  ë¶€ì¡± â†’ 409 Conflict
    if (ex instanceof BalanceException.ConcurrencyConflict || 
        ex instanceof ProductException.OutOfStock) 
        return HttpStatus.CONFLICT;
    
    // ê¸°íƒ€ ëª¨ë“  ê²½ìš° â†’ 400 Bad Request
    return HttpStatus.BAD_REQUEST;
}
```

### ğŸ“‹ ìƒíƒœ ì½”ë“œ ì˜ë¯¸
| ìƒíƒœ ì½”ë“œ | ì˜ë¯¸ | ì‚¬ìš© ì˜ˆì‹œ |
|-----------|------|-----------|
| 200 OK | ì„±ê³µ | ì¼ë°˜ì ì¸ ì„±ê³µ ì‘ë‹µ |
| 201 Created | ìƒì„± ì„±ê³µ | ì£¼ë¬¸ ìƒì„±, ì¿ í° ë°œê¸‰ |
| 400 Bad Request | ì˜ëª»ëœ ìš”ì²­ | ê¸°ë³¸ ì˜ˆì™¸ |
| 402 Payment Required | ê²°ì œ í•„ìš” | ì”ì•¡ ë¶€ì¡± |
| 403 Forbidden | ê¶Œí•œ ì—†ìŒ | ì£¼ë¬¸ ê¶Œí•œ ì—†ìŒ |
| 404 Not Found | ë¦¬ì†ŒìŠ¤ ì—†ìŒ | ìƒí’ˆ/ì£¼ë¬¸ ì—†ìŒ |
| 409 Conflict | ë¦¬ì†ŒìŠ¤ ì¶©ëŒ | ë™ì‹œì„± ì¶©ëŒ, ì¬ê³  ë¶€ì¡± |
| 410 Gone | ë” ì´ìƒ ì—†ìŒ | ì¿ í° ë§Œë£Œ/ì†Œì§„ |
| 500 Internal Server Error | ì„œë²„ ì˜¤ë¥˜ | ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ |

---

## ì‹¤ì œ êµ¬í˜„ ì˜ˆì‹œ

### ğŸ“ ì„±ê³µ ì‘ë‹µ ì˜ˆì‹œ
```json
# GET /api/balance/1 (ì„±ê³µ)
{
  "success": true,
  "message": "ìš”ì²­ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤",
  "data": {
    "userId": 1,
    "amount": 50000,
    "updatedAt": "2024-01-01T12:00:00"
  },
  "timestamp": "2024-01-01T12:00:00"
}

# POST /api/balance/charge (ì„±ê³µ, void)
{
  "success": true,
  "message": "ìš”ì²­ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤",
  "data": null,
  "timestamp": "2024-01-01T12:00:00"
}
```

### ğŸ“ ì‹¤íŒ¨ ì‘ë‹µ ì˜ˆì‹œ
```json
# ì”ì•¡ ë¶€ì¡± (402 Payment Required)
{
  "success": false,
  "message": "ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤",
  "data": null,
  "timestamp": "2024-01-01T12:00:00"
}

# ìƒí’ˆ ì—†ìŒ (404 Not Found)
{
  "success": false,
  "message": "ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
  "data": null,
  "timestamp": "2024-01-01T12:00:00"
}

# ì…ë ¥ê°’ ê²€ì¦ ì‹¤íŒ¨ (400 Bad Request)
{
  "success": false,
  "message": "ì‚¬ìš©ì IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤",
  "data": null,
  "timestamp": "2024-01-01T12:00:00"
}
```

---

## ğŸ“š í•µì‹¬ í•™ìŠµ í¬ì¸íŠ¸

### 1. ì•„í‚¤í…ì²˜ ì¥ì 
- **ê´€ì‹¬ì‚¬ ë¶„ë¦¬**: ê° í´ë˜ìŠ¤ê°€ í•˜ë‚˜ì˜ ì±…ì„ë§Œ ë‹´ë‹¹
- **ì¬ì‚¬ìš©ì„±**: CommonResponseë¥¼ ì—¬ëŸ¬ ê³³ì—ì„œ í™œìš©
- **ì¼ê´€ì„±**: ëª¨ë“  APIê°€ ë™ì¼í•œ ì‘ë‹µ í˜•ì‹
- **ìœ ì§€ë³´ìˆ˜ì„±**: ì‘ë‹µ í˜•ì‹ ë³€ê²½ ì‹œ í•œ ê³³ë§Œ ìˆ˜ì •

### 2. ì„¤ê³„ ì›ì¹™
- **ë‹¨ì¼ ì±…ì„ ì›ì¹™**: ê° í´ë˜ìŠ¤ëŠ” í•˜ë‚˜ì˜ ì—­í• ë§Œ
- **ê°œë°©-íì‡„ ì›ì¹™**: ìƒˆë¡œìš´ ì˜ˆì™¸ ì¶”ê°€ ì‹œ ê¸°ì¡´ ì½”ë“œ ë³€ê²½ ì—†ì´ í™•ì¥
- **ì˜ì¡´ì„± ì—­ì „**: ì¸í„°í˜ì´ìŠ¤(ResponseBodyAdvice)ì— ì˜ì¡´

### 3. ì‹¤ë¬´ ì ìš© íŒ
- **ì˜ˆì™¸ ë©”ì‹œì§€**: ì‚¬ìš©ì ì¹œí™”ì ì¸ í•œêµ­ì–´ ë©”ì‹œì§€
- **ë¡œê¹…**: ì‹¤ì œ ì˜ˆì™¸ ì •ë³´ëŠ” ì„œë²„ ë¡œê·¸ì—ë§Œ ê¸°ë¡
- **ìƒíƒœ ì½”ë“œ**: ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ë¯¸ì— ë§ëŠ” HTTP ìƒíƒœ ì½”ë“œ ì‚¬ìš©
- **ì‘ë‹µ ì‹œê°„**: timestampë¡œ ë””ë²„ê¹… ë° ëª¨ë‹ˆí„°ë§ ì§€ì› 