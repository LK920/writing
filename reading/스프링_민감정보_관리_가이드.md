# 스프링 부트 민감 정보 관리 가이드

## 1. 왜 민감 정보를 관리해야 할까?

개발을 하다 보면 API 키, 데이터베이스 접속 정보(ID, PW), JWT 시크릿 키 등 외부에 노출되어서는 안 되는 민감한 정보들을 다루게 됩니다. Node.js/Express 진영에서 `.env` 파일을 사용하여 환경 변수를 관리하고 `.gitignore`에 추가하여 Git 저장소에 올라가지 않도록 관리하는 것처럼, 스프링 부트 환경에서도 안전하게 민감 정보를 관리하는 체계적인 방법이 필요합니다.

이 가이드의 핵심 원칙은 **"설정은 코드와 분리한다"** 입니다. 민감 정보를 소스 코드나 Git 저장소에 직접 포함하는 것은 심각한 보안 사고로 이어질 수 있습니다.

## 2. 관리 방법 비교 (Express `.env` vs Spring Boot)

| 구분 | Express (`.env` + `dotenv`) | Spring Boot |
| --- | --- | --- |
| **형식** | 단순 Key-Value 텍스트 | 계층 구조의 YAML 또는 Properties |
| **로드 방식** | `dotenv` 라이브러리를 통해 명시적으로 로드 | 프레임워크에 내장된 강력한 설정 로드 기능 |
| **타입 안정성** | 문자열로만 로드됨 (수동 형변환 필요) | `@ConfigurationProperties` 등으로 객체에 자동 바인딩 (타입 안정성) |
| **환경 분리** | `.env.development`, `.env.production` 등 파일명으로 관리 | **프로파일(Profile)** 이라는 내장 기능으로 체계적 관리 |

---

## 3. 스프링 부트 민감 정보 관리 전략

스프링 부트에서는 하나의 정답만 있는 것이 아니라, 상황과 환경에 따라 여러 전략을 조합하여 사용합니다.

### 전략 1: 환경 변수 사용 (가장 표준적이고 안전한 방법)

운영 환경(Docker, Kubernetes) 배포 시 가장 권장되는 방식입니다. 코드 변경 없이 외부에서 설정을 주입할 수 있어 유연성과 보안성이 매우 높습니다.

**`src/main/resources/application.yml`**
```yaml
# 이 파일은 Git에 커밋해도 안전합니다.
api:
  external:
    key: ${EXTERNAL_API_KEY:}  # 시스템의 환경변수 EXTERNAL_API_KEY를 찾습니다.
    secret: ${EXTERNAL_API_SECRET:} # `:` 뒤에 기본값을 지정할 수 있습니다. (여기는 빈 값)
    base-url: ${EXTERNAL_API_URL:https://api.default.com} # 환경변수가 없으면 기본 URL 사용
```
- `${...}` 구문은 스프링이 외부 환경(환경 변수, JVM 시스템 속성 등)에서 해당 이름의 값을 찾아 주입하는 표준 방식입니다.

**실행 방법**
```bash
# 셸에서 직접 환경변수를 설정하고 애플리케이션을 실행
export EXTERNAL_API_KEY=your-secret-key
export EXTERNAL_API_SECRET=your-secret-value

./gradlew bootRun
```

### 전략 2: 외부 설정 파일 참조 (로컬 개발 및 특정 환경에 유용)

민감 정보만 별도의 파일에 작성하고, 애플리케이션 실행 시 이 파일을 참조하도록 설정합니다. 이 민감 정보 파일은 당연히 `.gitignore`에 추가해야 합니다.

**`application-secret.yml` (프로젝트 내 어디든 위치 가능, Git에 추가하지 않음)**
```yaml
# 이 파일은 절대로 Git에 커밋하지 않습니다.
api:
  external:
    key: your-secret-key
    secret: your-secret-value
    base-url: https://api.real.com
```

**`.gitignore`**
```gitignore
# 민감한 설정 파일
*.secret.yml
application-secret.yml
```

**실행 방법**
```bash
# 실행 시점에 추가 설정 파일의 위치를 알려줍니다.
./gradlew bootRun --spring.config.additional-location=file:./application-secret.yml
```
- `spring.config.additional-location` 옵션을 통해 기본 `application.yml` 외에 추가 설정을 어디서 가져올지 지정할 수 있습니다.

### 전략 3: 스프링 프로파일(Profile)과 설정 파일 분리 (가장 실용적인 조합)

스프링의 **프로파일**은 `local`, `dev`, `staging`, `prod` 등 특정 환경을 식별하는 이름입니다. 프로파일을 사용하여 환경별로 다른 설정 파일을 적용할 수 있습니다. 이는 로컬 개발, 테스트, 운영 환경의 설정을 체계적으로 분리하는 가장 일반적이고 강력한 방법입니다.

#### 3-1. 기본 설정 및 프로파일 활성화

**`src/main/resources/application.yml` (공통 설정, Git에 커밋)**
```yaml
spring:
  application:
    name: hhplus
  profiles:
    active: local # 기본으로 'local' 프로파일을 활성화합니다.

# 모든 환경에 적용될 공통 설정 또는 플레이스홀더
# (환경 변수가 주입되지 않으면 이 값이 사용됨)
api:
  external:
    key: ${EXTERNAL_API_KEY:default_key}
    secret: ${EXTERNAL_API_SECRET:default_secret}
    base-url: ${EXTERNAL_API_URL:https://api.default.com}
```

#### 3-2. 로컬 개발 환경 구성 (Git에 커밋)

**`src/main/resources/application-local.yml` (Git에 커밋)**
```yaml
# 'local' 프로파일이 활성화될 때 적용되는 설정입니다.
spring:
  # H2 DB 등 로컬 개발에 필요한 비민감성 설정을 여기에 둡니다.
  datasource:
    url: jdbc:h2:mem:hhplus
    username: sa
    password: 
    driver-class-name: org.h2.Driver
  
  # 로컬 전용 민감 정보 파일을 선택적으로(optional) 불러옵니다.
  # 이 파일이 없어도 애플리케이션은 에러 없이 실행됩니다.
  config:
    import: optional:file:./application-local-secret.yml 
```

#### 3-3. 개인별 로컬 민감 정보 파일 (Git에 추가하지 않음)

각 개발자는 자신의 PC에 아래 파일을 생성하여 개인의 민감 정보를 관리합니다.

**`application-local-secret.yml` (프로젝트 루트에 생성, Git에 추가하지 않음!)**
```yaml
# 이 파일은 .gitignore에 의해 추적되지 않아야 합니다.
# 각 개발자의 로컬 환경에서만 사용되는 실제 키 값들입니다.
api:
  external:
    key: my-personal-local-key
    secret: my-personal-local-secret
    base-url: http://localhost:8081/mock-api
```

**`.gitignore` 에 반드시 추가**
```gitignore
# 민감한 설정 파일들
application-*-secret.yml
application-local-secret.yml
*.secret.yml

# 환경변수 파일 (필요 시)
.env
```

#### 3-4. 운영/스테이징 환경 구성

운영(prod)이나 스테이징(staging) 환경에서는 보통 프로파일을 활성화하고, **전략 1**에서 설명한 환경 변수를 통해 민감 정보를 주입합니다.

**실행 방법 (운영 환경 예시)**
```bash
# 1. 운영 환경용 환경 변수 설정
export EXTERNAL_API_KEY=real-production-api-key
export EXTERNAL_API_SECRET=real-production-api-secret
export EXTERNAL_API_URL=https://api.production.com

# 2. 'prod' 프로파일을 활성화하여 실행
#    이렇게 하면 application-prod.yml 설정을 읽어옵니다.
./gradlew bootRun --spring.profiles.active=prod
```

## 4. 클라우드/전문 솔루션 사용 (최고 수준의 보안)

대규모 프로덕션 환경에서는 더욱 안전한 방법을 사용합니다.
- **AWS Secrets Manager**
- **Google Cloud Secret Manager**
- **HashiCorp Vault**

이러한 도구들은 민감 정보를 중앙에서 안전하게 저장하고, IAM 역할(Role) 기반으로 애플리케이션에 동적으로 자격 증명을 주입해줍니다. 코드나 서버 환경 변수에 직접 키를 보관할 필요가 없어 가장 안전합니다.

## 결론 및 추천 전략

- **절대 원칙**: `*.secret.yml`, `application-prod.yml` 등 민감 정보가 포함된 파일은 **절대로 Git에 커밋하지 말고 `.gitignore`에 추가**하세요.
- **로컬 개발**: **전략 3 (프로파일 + optional import)** 방식을 사용하여 팀원들과 협업 효율을 높이세요. 각자 `application-local-secret.yml` 파일을 만들어 관리하면 됩니다.
- **운영 환경**: **전략 1 (환경 변수)** 또는 **클라우드 솔루션**을 사용하여 보안을 극대화하세요.
