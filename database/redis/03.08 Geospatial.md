---
aliases:
  - 레디스_기본_개념
  - 레디스_geospatial
tags:
  - 레디스
  - redis
  - 레디스기본개념
  - 레디스자료구조
  - geospatial
---
# Redis Geospatial 자료구조

## 기본 개요

**경도(Longitude)와 위도(Latitude) 데이터 쌍으로 지리적 위치 정보를 저장하고 조회하는 자료구조**입니다.

- **저장 형식**: 경도, 위도, 멤버명 (예: 127.0276, 37.4979, "서울시청")
- **내부 구조**: Sorted Set을 기반으로 구현 (스코어는 지오해시)
- **유일성**: 하나의 키 내에서 멤버는 중복 저장 불가능
- **활용**: 근처 매장 검색, 배달 위치 추적, 위치 기반 서비스 등

---

## 좌표계 이해하기

### 경도(Longitude) vs 위도(Latitude)

```
위도(Latitude)
↑ 북쪽 90도
│
│  37.4979 (서울)
│
├─────────────────→ 경도(Longitude)
│  
│  0도 (그리니치 자오선)
↓
남쪽 -90도


경도: -180 ~ 180 (동쪽 양수, 서쪽 음수)
위도: -90 ~ 90 (북쪽 양수, 남쪽 음수)
```

### 한국 주요 도시 좌표

```
서울:     경도 127.0276, 위도 37.4979
부산:     경도 129.0756, 위도 35.1796
대구:     경도 128.5710, 위도 35.8714
인천:     경도 126.7052, 위도 37.2557
```

---

## 내부 저장 구조

### Sorted Set 기반 구현

```
Geospatial은 내부적으로 Sorted Set으로 저장됩니다:

키: "cafe"
멤버 1: "gangnam_cafe"  → 스코어: (지오해시로 변환된 숫자)
멤버 2: "hongdae_cafe"  → 스코어: (지오해시로 변환된 숫자)
멤버 3: "myeongdong_cafe" → 스코어: (지오해시로 변환된 숫자)

사용자는 GEOPOS로 조회할 때 원래 경도, 위도가 반환됨
```

---

## 핵심 커맨드

### 1. GEOADD: 위치 데이터 추가

```
GEOADD key 경도 위도 member [경도 위도 member ...]
```

**설명**: 지정된 키에 위치 정보를 저장합니다.

**예시: 카페 위치 저장**

```
# 강남역 카페
GEOADD cafe 127.0276 37.4979 "gangnam_cafe"

# 여러 카페 한번에 추가
GEOADD cafe \
  127.0276 37.4979 "gangnam_cafe" \
  126.9917 37.5642 "hongdae_cafe" \
  126.9882 37.5665 "myeongdong_cafe"

반환: 3 (3개 추가됨)
```

---

### 2. GEOPOS: 저장된 위치 조회

```
GEOPOS key member [member ...]
```

**설명**: 저장된 멤버의 경도, 위도를 조회합니다.

**예시**

```
GEOPOS cafe "gangnam_cafe"
→ 결과: [127.02759, 37.49790] (약간의 부동소수점 오차 가능)

# 여러 카페 위치 조회
GEOPOS cafe "gangnam_cafe" "hongdae_cafe" "myeongdong_cafe"
→ 결과:
   [127.02759, 37.49790]
   [126.99167, 37.56424]
   [126.98822, 37.56656]
```

---

### 3. GEODIST: 두 위치 사이의 거리 계산

```
GEODIST key member1 member2 [m|km|ft|mi]
```

**거리 단위**:

- `m`: 미터 (기본값)
- `km`: 킬로미터
- `ft`: 피트
- `mi`: 마일

**예시**

```
저장된 카페 위치:
GEOADD cafe \
  127.0276 37.4979 "gangnam_cafe" \
  126.9917 37.5642 "hongdae_cafe" \
  126.9882 37.5665 "myeongdong_cafe"

# 강남 카페와 명동 카페 사이의 거리 (단위: 킬로미터)
GEODIST cafe "gangnam_cafe" "myeongdong_cafe" km
→ 결과: 8.3741 (약 8.37km)

# 강남 카페와 홍대 카페 사이의 거리
GEODIST cafe "gangnam_cafe" "hongdae_cafe" km
→ 결과: 8.0151 (약 8.01km)

# 홍대 카페와 명동 카페 사이의 거리
GEODIST cafe "hongdae_cafe" "myeongdong_cafe" km
→ 결과: 0.4008 (약 0.40km = 약 400미터)

# 미터 단위
GEODIST cafe "gangnam_cafe" "myeongdong_cafe" m
→ 결과: 8374.1 (약 8,374미터)

# 존재하지 않는 멤버
GEODIST cafe "gangnam_cafe" "nonexistent_cafe" km
→ 결과: (nil)
```

---

### 4. GEOSEARCH: 범위 내 위치 검색 (가장 강력!)

```
GEOSEARCH key FROMMEMBER member BYRADIUS radius m|km|ft|mi [WITHCOORD] [WITHDIST] [COUNT count]
GEOSEARCH key FROMMEMBER member BYBOX width height m|km|ft|mi [WITHCOORD] [WITHDIST] [COUNT count]
```

**옵션 설명**:

- `FROMMEMBER`: 기준이 되는 멤버
- `BYRADIUS`: 반경 거리 기준 (원형)
- `BYBOX`: 직사각형 범위 기준
- `WITHCOORD`: 결과에 좌표 포함
- `WITHDIST`: 결과에 거리 포함
- `COUNT`: 반환할 결과 개수 제한

---

#### BYRADIUS: 반경 기준 검색

```
# 강남 카페로부터 5km 이내의 모든 카페
GEOSEARCH cafe FROMMEMBER "gangnam_cafe" BYRADIUS 5 km

# 결과: 강남 카페만 해당
# (명동 카페 8.37km, 홍대 카페 8.01km은 범위 밖)

결과:
1) "gangnam_cafe"


# 강남 카페로부터 9km 이내 카페 (거리 정보 포함)
GEOSEARCH cafe FROMMEMBER "gangnam_cafe" BYRADIUS 9 km WITHDIST

결과:
1) 1) "gangnam_cafe"
   2) "0.0000"
3) 1) "hongdae_cafe"
   4) "8.0151"
5) 1) "myeongdong_cafe"
   6) "8.3741"


# 강남 카페로부터 15km 이내 카페 (좌표와 거리 모두 포함)
GEOSEARCH cafe FROMMEMBER "gangnam_cafe" BYRADIUS 15 km WITHCOORD WITHDIST

결과:
1) 1) "gangnam_cafe"
   2) "0.0000"
   3) 1) "127.02759772539139"
      2) "37.49799946695612"
4) 1) "hongdae_cafe"
   5) "8.0151"
   6) 1) "126.99169903993607"
      2) "37.56419877947457"
7) 1) "myeongdong_cafe"
   8) "8.3741"
   9) 1) "126.98820143938065"
      2) "37.56650030628725"


# 상위 2개만 반환
GEOSEARCH cafe FROMMEMBER "gangnam_cafe" BYRADIUS 15 km COUNT 2

결과:
1) "gangnam_cafe"
2) "hongdae_cafe"
```

---

#### BYBOX: 직사각형 범위 검색

```
# 강남 카페로부터 가로 10km, 세로 5km 직사각형 범위 내 카페
GEOSEARCH cafe FROMMEMBER "gangnam_cafe" BYBOX 10 5 km

# 직사각형 범위 + 거리 정보
GEOSEARCH cafe FROMMEMBER "gangnam_cafe" BYBOX 10 5 km WITHDIST
→ 범위 안의 카페들과 거리 반환

# 직사각형 범위 + 좌표 + 거리
GEOSEARCH cafe FROMMEMBER "gangnam_cafe" BYBOX 10 5 km WITHCOORD WITHDIST
```

---

## BYRADIUS vs BYBOX 비교

```
BYRADIUS (원형 범위):
        ╱─────╲
       ╱       ╲
      │    ●    │  ← 반경 5km 원형
       ╲       ╱
        ╲─────╱

모든 방향으로 같은 거리

BYBOX (직사각형 범위):
  ┌─────────────┐
  │      ●      │  ← 가로 10km, 세로 5km 직사각형
  └─────────────┘

가로 세로가 다를 수 있음
```

---

## 시간 복잡도

|작업|시간복잡도|설명|
|---|---|---|
|GEOADD|**O(log N)**|Sorted Set 삽입|
|GEOPOS|**O(N)**|N = 조회할 멤버 수|
|GEODIST|**O(log N)**|두 멤버 거리 계산|
|GEOSEARCH|**O(log N + M)**|M = 검색 범위 내 멤버 수|

---

## 실제 사용 예제

### 예제 1: 배달 앱의 근처 음식점 검색

```
# 음식점 위치 저장
GEOADD restaurant \
  127.0276 37.4979 "강남치킨" \
  126.9917 37.5642 "홍대피자" \
  126.9882 37.5665 "명동버거" \
  127.1086 37.5705 "강북카페"

# 사용자가 강남치킨에서 9km 이내의 음식점 검색
GEOSEARCH restaurant FROMMEMBER "강남치킨" BYRADIUS 9 km WITHDIST

결과:
1) 1) "강남치킨"
   2) "0.0000"
3) 1) "명동버거"
   4) "8.3741"
5) 1) "홍대피자"
   6) "8.0151"

# 5km 이내만 검색
GEOSEARCH restaurant FROMMEMBER "강남치킨" BYRADIUS 5 km WITHCOORD WITHDIST

결과:
1) 1) "강남치킨"
   2) "0.0000"
   3) 1) "127.02759772539139"
      2) "37.49799946695612"
```

---

### 예제 2: 택시 앱의 근처 택시 찾기

```
# 택시 위치 실시간 저장
GEOADD taxi \
  127.0276 37.4979 "taxi_001" \
  127.0300 37.4985 "taxi_002" \
  127.0290 37.4980 "taxi_003"

# 고객 위치: 127.0280, 37.4982
# 고객 위치에서 1km 이내의 택시 (상위 3개)
GEOSEARCH taxi FROMMEMBER "taxi_001" BYRADIUS 1 km COUNT 3 WITHDIST
→ 가까운 순서대로 3개 택시 반환

# 택시 위치 업데이트 (계속 움직임)
GEOADD taxi 127.0320 37.4990 "taxi_001"  (위치 변경)
```

---

### 예제 3: 주변 카페 랭킹

```
# 전국 카페 위치 저장
GEOADD cafe \
  127.0276 37.4979 "강남 카페" \
  126.9917 37.5642 "홍대 카페" \
  126.9882 37.5665 "명동 카페" \
  127.1086 37.5705 "강북 카페" \
  128.5710 35.8714 "대구 카페"

# 강남 카페로부터 가까운 카페들 (거리순 정렬)
GEOSEARCH cafe FROMMEMBER "강남 카페" BYRADIUS 10 km WITHDIST

결과:
1) 1) "강남 카페"
   2) "0.0000"
3) 1) "명동 카페"
   4) "8.3741"
5) 1) "홍대 카페"
   6) "8.0151"

# 참고: 대구 카페는 강남에서 약 237km 떨어져 있음
```

---

## 중요한 특징

### 1. 멤버 중복 관리

```
GEOADD cafe 127.0276 37.4979 "gangnam_cafe"
→ 1 (새로 추가됨)

GEOADD cafe 127.0300 37.4985 "gangnam_cafe"
→ 0 (이미 있음, 위치만 업데이트)

# 같은 멤버는 하나만 존재
ZCARD cafe → 1
```

---

### 2. 부동소수점 오차

```
저장할 때: 127.0276, 37.4979
조회할 때: 127.02759, 37.49790 (약간 다를 수 있음)

이유: 내부적으로 지오해시(64비트)로 변환되므로
거리: GEODIST로 계산하면 대부분 정확함
```

---

### 3. FROMLONLAT 옵션

```
# 멤버를 기준으로 검색
GEOSEARCH cafe FROMMEMBER "gangnam_cafe" BYRADIUS 5 km

# 직접 좌표를 입력하여 검색 (멤버가 없는 위치)
GEOSEARCH cafe FROMLONLAT 126.9720 37.5537 BYRADIUS 5 km
→ 서울역 좌표 기준으로 검색
```

---

## 실무 활용 패턴

### 배달/라이드 서비스

```
// 음식점 위치 저장
GEOADD restaurant 127.0276 37.4979 "restaurant:1"
GEOADD restaurant 126.9917 37.5642 "restaurant:2"

// 사용자 위치에서 9km 이내 음식점 검색
GEOSEARCH restaurant FROMLONLAT 127.0276 37.4979 BYRADIUS 9 km WITHDIST

// 두 음식점 사이 거리 확인
GEODIST restaurant "restaurant:1" "restaurant:2" km
→ 8.0151km

// 거리 기반 배달비 결정
if (거리 < 3km) → 배달비 2,000원
else if (거리 < 6km) → 배달비 3,000원
else → 배달비 5,000원
```

---

## 주의사항

### ⚠️ 정확도

```
Geospatial은 근사치 계산
- 구형 지구 모델 사용 (실제 지구와 약간 다름)
- 일반적으로 수 미터 정도 오차
- 배달 앱 수준에서는 충분히 정확
```

### ⚠️ 성능

```
GEOSEARCH는 범위가 커질수록 느려짐
- 범위: 큰 값 (예: 50km) 사용 시 주의
- COUNT 옵션으로 결과 제한 권장
- 인덱싱 불가능 (매번 계산)
```

---

## 핵심 정리

|커맨드|용도|반환값|
|---|---|---|
|**GEOADD**|위치 추가/업데이트|추가된 개수|
|**GEOPOS**|위치 조회|경도, 위도|
|**GEODIST**|거리 계산|거리 값|
|**GEOSEARCH**|범위 검색|멤버 목록|

---

## 정말 간단하게

```
GEOADD    = 지도에 표시 📍
GEOPOS    = 표시된 위치 확인
GEODIST   = 두 위치 사이 거리 재기
GEOSEARCH = 범위 내 찾기 🔍
```