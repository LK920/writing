# 개발자를 위한 레디스

 이 문서는 "개발자를 위한 레디스"라는 책을 읽고 학습한 내용입니다.
 
---

## NoSQL과 Redis
### NoSQL
- 특징
	- 실시간 응답 -> 빠른 응답 요구
	- 확장성
	- 고가용성
	- 클라우드 네이티브
	- 단순성
	- 유연성
		- 비정형  데이터
- 데이터 저장소 유형
	- 그래프
		- node : 데이터의 엔티티
		- edges : 데이터 사이의 관계
			- 항상 시작/끝 노드, 유형, 방향을 가짐
			- 상-하위 관계, 동작, 소유자 정보
		- properties 
		- 추천서비스 유용
			- sns 친구 추천
			- 쇼핑몰 제품 추천
	- 칼럼
		- 열 위주 저장
		- 집계 쿼리 처리 빠름
		- 분석,보고,빅데이터 처리
		- 카산드라, hbase
	- 키-값
		- redis
		- 수평확장
		- 실시간 서비스에서 사용자의 경험을 위해 빠른 응당 속도
		- 로그, 대규모 세션 실시간 관리 상황에서 유용
	- 문서
		- json형태 저장
		- 항상 키와 연결되는 계층적 트리 구조
		- 스키마 정해지지 않음
		- mongodb, documentDB
### Redis
- 특징
	- 실시간 응답
	- 단순성 -> 싱글 스레드(메인 스레드 1개, 별도 스레드 3개로 동작)
	- 가용성 -> sentinel, fail-over
	- 확장성 -> cluster mode, 수평확장, 샤딩, 클러스터 버스(서로 감시, fail-over)
	- 클라우드 네이티브 - 멀티 클라우드(여러 클라우드에서 일관성과, 연속성 획득)
- 레디스의 용도
	- 메시지 브로커
		- 비동기적 통신
		- pub/sub
		- 메시징 큐(list 자료 구조)
		- 스트림 플랫폼(stream 자료 구조)
			- 데이터는 계속해서 추가되는 방식으로 저장
	- 데이터 저장소
		- 영속성
		- 주기적 백업(AOF,RDB)
---
## 레디스 시작하기
### 레디스 설치
```
// MacOS
설치
brew install redis
실행
brew services start redis -> 
or
redis-server
```
## 레디스 환경 구성(리눅스 환경 권장)
### 서버 환경 설정 변경(레디스가 설치된 서버의 환경 설정)
#### Open files 확인
- 레디스 기본 maxClient = 10000
	- 레디스 프로세스에서 받아 들일 수 있는 최대 클라이언트 수
	- 레디스 실행하는 서버의 파일 디스크립터 수에 영향
	- 레디스 프로세스 내부적으로 예약한 파일 디스크립터 수 32개를 사용
		- 32개는 권장 수, 실제로 테스트할 경운 32개보다 덜 사용할 수 있음
		```
		// open files : 300 설정
		❯ ulimit -n
		300
		// 동시 클라이언트 수 295, 요청 개수 100000 하단 실패 지점 있음
		❯ redis-benchmark -c 295 -n 10000 -q
		PING_INLINE: 93457.95 requests per second, p50=1.199 msec
		PING_MBULK: 111111.11 requests per second, p50=0.927 msec
		SET: 105263.16 requests per second, p50=0.911 msec
		GET: 109890.11 requests per second, p50=1.087 msec
		INCR: 107526.88 requests per second, p50=1.023 msec
		LPUSH: 106382.98 requests per second, p50=0.911 msec
		RPUSH: 103092.78 requests per second, p50=0.943 msec
		LPOP: 98039.22 requests per second, p50=0.911 msec
		RPOP: 106382.98 requests per second, p50=0.935 msec
		SADD: 105263.16 requests per second, p50=0.951 msec
		HSET: 102040.82 requests per second, p50=1.087 msec
		SPOP: 112359.55 requests per second, p50=0.935 msec
		ZADD: 117647.05 requests per second, p50=0.935 msec
		Could not connect to Redis at 127.0.0.1:6379: Can't assign requested address

		```
	- 레디스 실행하는 서버의 파일 디스크립터 수는 "레디스 클라이언트 수 + 32"를 상정하여 설정해야 함
	- 레디스의 최대 클라이언트 수를 10000으로 지정하고 싶으면 서버의 파일 디스크립터 수를 10032로 맞춰야함
	- 만약 `ulimit -n` 으로 나온 수가 256이면 레디스에서 받아 들일 수 있는 클라이언트는 최대 224이라고 생각하면 됨
- (번외)brew 실행과 일반 실행의 차이

| 항목         | redis-server | brew service         |
| :--------- | ------------ | -------------------- |
| ulimit 적용  | ✅ 적용됨        | ❌ 시스템 기본값            |
| 터미널 닫아도 실행 | ❌ 종료됨        | ✅ 계속 실행              |
| 재부팅 후      | 수동 재시작       | 자동 시작                |
| 로그 확인      | 터미널에 출력      | 파일 확인 필요 -> 백그라운드 실행 |
| 사용용도       | 학습           | 실사용                  |

#### vm.overcommit_memory=1로 변경
 디스크 파일 저장시 cow 메커니즘이 동작 이때 필요한 메모리를 초과 사용할 수 있음
 - 0 : 초과 할당 제한
 - 1 : 초과 할당 가능(cow시 순간적으로 초과할당 될 수 있음)
 - 번외 - [redis 백업 방식](obsidian://open?vault=lk's_brains&file=study%2Fdatabase%2Fredis%2F02.redis-backup-guide)
	- aop : 모든 명령어를 로그처럼 저장
	- rdb : 스냅샷 방식으로 저장,일정 손실 감안하고 백업
	- cow(copy on write) 백그라운드 백업 시 사용되는 매커니즘
		- 우선 복사 후 백업 완료시 쓰기 -> 메모리 효율적 사용 가능
```
		예시
		[백업 시작]
		┌─────────────────────┐
		│  메모리 10GB         │
		│  key1 | key2 | key3  │
		└─────────────────────┘
		   ↑         ↑
		   │         │
		부모(Redis) 자식(백업)
		같은 메모리 공유!
		
		[key1 수정 시] 이 때 메모리 10.01GB
		┌─────────────────────┐
		│  메모리 10GB         │
		│ key1_old ← 자식만    │
		│ key2 ← 둘 다 공유    │
		│ key3 ← 둘 다 공유    │
		└─────────────────────┘
		┌─────────────┐
		│ 메모리 0.01GB │
		│ key1_new    │ ← 부모만
		└─────────────┘
		
		[백업 완료] 메모리 10GB(key1_new에 사용됨 메모리 삭제)
		┌─────────────────────┐
		│  메모리 10GB         │
		│ key1_new             │
		│ key2                 │
		│ key3                 │
		└─────────────────────┘
		(old 버전 삭제됨!)
```

#### THP 비활성화
#### somaxconn과 syn_backlog 설정 변경
- 레디스 설정 파일 `tcp-backlog` : 클라이언트와 통신할 때 사용하는 tcp backlog 큐의 크기 지정
	- 기본 : 511
- 레디스의 tcp-backlog 값이 서버의 somaxconn + syn_backlog 값 보다 클 수 없다.
	- 서버 설정값 위치 : `/etc/sysctl.conf`
	- somaxconn?
	- syn_backlog?
### 레디스 설정 파일 변경
#### port
- 기본값 : 6379
#### bind
- 레디스 접근 가능한 ip 값 지정
- 기본값 : 127.0.0.1 (서버 내부에서만 접근 가능)
- `0.0.0.0` : 모든 IP 접근 가능
- 레디스 서버에 접근한 ip만 별도로 지정하는 게 좋음
#### protected-mode
- 기본값 : yes
- 패스워드 설정 필수
- 패스워드 설정하지 않을 경우 로컬 연결만 수신 가능
#### requirepass / masterauth
- requirepass : 서버 접속 패스워드
- masterauth : 연결될 마스터의 패스워드 값(복제 구조일 때 사용)
- 복제 구조 사용할 경우 두 파라미터를 같은 값으로 사용 권장
#### daemonize
- 기본값 : no
- 레디스 프로세스를 데몬으로 실행시키려면 yes로 변경
- 데몬 실행 시 백그라운드 실행
- pid파일 생성됨
- pid파일은 pidfile이라는 파라미터로 제어, 기본값 `/var/run/redis_6379.pid`
#### dir
- 기본값 : ./
- 레디스 워킹 디렉터리
- 로그, 백업 시 해당 파라미터에서 지정한 디렉터리에 저장
