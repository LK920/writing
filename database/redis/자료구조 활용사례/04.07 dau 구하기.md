---
aliases:
  - dau 구하기
tags:
  - redis
  - bitmap
  - 비트맵
  - dau
---
## Bitmap을 이용한 DAU 구하기

### DAU란?

**DAU (Daily Active User)**: 하루 동안 서비스에 방문한 순수 사용자 수

주요 특징:
- 하루에 여러 번 방문하더라도 1명으로 카운팅
- 사용자의 유니크한 수를 파악할 수 있는 핵심 지표

### 기존 방식의 한계

#### 배치 처리 방식
- 사용자 접속 로그를 활용해 날마다 배치 처리 수행
- 실시간 데이터 확인 불가

#### Set 자료구조 사용 시
- 구현은 가능하나 메모리 사용량이 큼
- 키 하나당 최대 200~300만 개의 아이템 권장
- 사용자가 많아질수록 메모리 용량 급증

### Bitmap 자료구조의 장점

#### 메모리 효율성
- 사용자 ID는 0 이상의 정수로 관리
- 키당 최대 512MB (비트맵은 String 자료구조 기반)
- **예시**: 사용자 1,000만 명 기준 약 **1.2MB** 크기 (매우 효율적!)

#### 성능
- 빠른 비트 연산
- 실시간 조회 가능

### 기본 사용 방법

#### 1. 사용자 방문 기록
유저 ID가 14인 유저가 접근했을 때 오프셋 14를 1로 설정

```redis
SETBIT uv:20251103 14 1
```

**내부 표현:**
```
uv:20251103 → 0000 0000 0000 0010 ...
               ↑    ↑    ↑    ↑
              위치 0   8   12   14 (1로 설정됨)
```

#### 2. 해당 일자 DAU 확인
```redis
# 비트맵 중 1인 값의 개수를 가져옴 (= 방문한 유저 수)
BITCOUNT uv:20251103
```

### 비트 연산을 활용한 고급 기능

`BITOP` 커맨드를 사용하여 AND, OR, XOR, NOT 연산을 수행할 수 있습니다.

#### 예제: 3일 연속 접속한 유저 구하기

**1일차 (2025-11-01): 유저 1, 7, 10, 14, 15가 접속**
```redis
SETBIT uv:20251101 1 1
SETBIT uv:20251101 7 1
SETBIT uv:20251101 10 1
SETBIT uv:20251101 14 1
SETBIT uv:20251101 15 1
```
→ uv:20251101 비트맵: `0100 0001 0001 0011`

**2일차 (2025-11-02): 유저 3, 4, 7, 8, 9, 14가 접속**
```redis
SETBIT uv:20251102 3 1
SETBIT uv:20251102 4 1
SETBIT uv:20251102 7 1
SETBIT uv:20251102 8 1
SETBIT uv:20251102 9 1
SETBIT uv:20251102 14 1
```
→ uv:20251102 비트맵: `0001 1001 1100 0010`

**3일차 (2025-11-03): 유저 3, 7, 11, 14가 접속**
```redis
SETBIT uv:20251103 3 1
SETBIT uv:20251103 7 1
SETBIT uv:20251103 11 1
SETBIT uv:20251103 14 1
```
→ uv:20251103 비트맵: `0001 0001 0001 0010`

#### AND 연산: 3일 모두 접속한 유저
```redis
BITOP AND event:202511-3days uv:20251101 uv:20251102 uv:20251103

# 결과 확인
BITCOUNT event:202511-3days
# 유저 7, 14 → 2명
```

#### OR 연산: 3일 중 한 번이라도 접속한 유저
```redis
BITOP OR event:202511-any uv:20251101 uv:20251102 uv:20251103

# 결과 확인
BITCOUNT event:202511-any
# 유저 1, 3, 4, 7, 8, 9, 10, 11, 14, 15 → 10명
```

### 비트맵 데이터 활용

비트맵은 내부적으로 String 자료구조로 저장되므로 `GET` 커맨드로 조회할 수 있습니다.

```redis
GET event:202511-3days
```

필요한 경우 다음과 같은 방식으로 비트 값을 추출할 수 있습니다:
1. 각 문자를 이진 비트로 변환
2. 모든 비트를 왼쪽에서 오른쪽으로 순회하면서 비트 값 추출
3. 1로 설정된 비트의 인덱스를 수집 (= 방문한 유저 ID 목록)
 
 