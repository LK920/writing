---
aliases:
  - 안 읽은 메시지 수
tags:
  - redis
  - hash
  - counting
---
## Hash를 이용한 읽지 않은 메시지 수 카운팅

채팅 애플리케이션에서 사용자가 속한 채널별로 읽지 않은 메시지를 효율적으로 관리하는 방법입니다.

### 기존 방식의 문제점

채팅 메시지가 도착할 때마다 DB에 직접 UPDATE를 수행하면:
- 빈번한 DB 쓰기 작업으로 인한 부하 발생
- 실시간 처리 성능 저하

### Redis Hash를 이용한 개선 방식

Redis와 같은 인메모리 DB에 일시적으로 저장 후, 필요한 시점에 한꺼번에 DB에 업데이트하는 방식으로 성능을 개선할 수 있습니다.

### 데이터 구조

```
Key: user:{사용자ID}
Field: channel:{채널ID}
Value: 읽지 않은 메시지 수
```

**예시:**
```
user:123
  ├─ channel:4234 → 3
  ├─ channel:5678 → 7
  └─ channel:9012 → 1
```

### 사용 방법

#### 새 메시지 도착 시 카운트 증가
```redis
# 채널 4234에 새 메시지가 도착하면 카운트 +1
HINCRBY user:123 channel:4234 1
```

#### 메시지 읽음 처리 시 카운트 감소
```redis
# 사용자가 메시지 1개를 읽으면 카운트 -1
HINCRBY user:123 channel:4234 -1
```

#### 특정 채널의 읽지 않은 메시지 수 조회
```redis
# 채널 4234의 읽지 않은 메시지 수 조회
HGET user:123 channel:4234
```

#### 모든 채널의 읽지 않은 메시지 수 조회
```redis
# 사용자 123의 모든 채널별 읽지 않은 메시지 수 조회
HGETALL user:123
# 결과: channel:4234 3, channel:5678 7, channel:9012 1
```

#### 채널 진입 시 카운트 초기화
```redis
# 사용자가 채널에 진입하여 모든 메시지를 읽음
HDEL user:123 channel:4234
# 또는
HSET user:123 channel:4234 0
```

### 장점
- 빠른 읽기/쓰기 성능
- 채널별로 독립적인 카운트 관리
- 여러 채널의 정보를 한 번에 조회 가능
- DB 부하 감소
