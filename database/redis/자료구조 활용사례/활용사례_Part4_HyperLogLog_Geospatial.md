---
aliases:
  - Redis 위치 기반 서비스
  - HyperLogLog 활용사례
tags:
  - Redis
  - HyperLogLog
  - Geospatial
  - API미터링
  - 위치기반서비스
  - 근사치알고리즘
  - 배달앱
  - 지도서비스
  - 사용량측정
  - LBS
---

# Redis 자료구조 활용사례 Part 4: 12KB로 무제한 카운팅? HyperLogLog의 마법

> 이 시리즈는 책에서 소개된 다양한 자료구조를 실전에서 활용하는 방법을 소개합니다.
> - Part 1: 게임 랭킹, RDBMS 대신 Redis로 구현하면? (Sorted Set)
> - Part 2: 좋아요 중복 방지, Redis Set으로 간단하게 해결
> - Part 3: 1000만 사용자 DAU를 1.2MB로 추적하는 방법 (Bitmap)
> - **Part 4: 12KB로 무제한 카운팅? HyperLogLog의 마법** (현재 글)

---

## 1. HyperLogLog를 이용한 애플리케이션 미터링

### 개요

**미터링(Metering)**: 사용량을 정량적으로 측정하고 기록하는 것

즉, 사용자가 얼마나 서비스를 사용했는지 정확하게 측정하는 방법입니다.

### 요구사항

미터링 솔루션은 사용자의 서비스 사용 내역을 처리하기 때문에:
- 대용량 데이터 처리 능력 필요
- 높은 처리량(High Throughput)
- 낮은 대기 시간(Low Latency)

### HyperLogLog 사용 조건

다음 조건을 만족할 때 HyperLogLog 사용을 고려할 수 있습니다:
- 집합 내의 유일한 데이터의 개수만 카운팅하면 됨
- 1% 미만의 오차는 허용 가능
- 카운팅할 때 사용한 정확한 데이터를 다시 확인할 필요 없음

### 일반적인 방법 vs HyperLogLog

#### 일반적인 방법 (Set 사용)
- 중복을 피하기 위해 저장된 데이터를 모두 메모리에 보관
- 데이터가 많아질수록 메모리 사용량 급증

#### HyperLogLog 방법
- 저장된 데이터를 다시 확인할 필요가 없다면 최소한의 메모리만 사용
- 중복되지 않는 데이터의 개수를 효율적으로 계산 가능
- **고정된 메모리 사용량: 최대 12KB**

### 사용 방법

#### 1. API 호출 기록 추가
2025년 11월에 ID가 245인 유저의 API 호출을 추적하려면, API를 호출할 때마다 `PFADD` 커맨드를 이용해 로그 식별자를 저장합니다.

```redis
# 유저 245가 API 호출 (로그 식별자: 29583)
PFADD 202511:user:245 29583

# 같은 유저의 또 다른 API 호출 (로그 식별자: 29584, 29585)
PFADD 202511:user:245 29584 29585

# 중복된 호출은 카운트되지 않음
PFADD 202511:user:245 29583
```

#### 2. 유니크 API 호출 개수 조회
```redis
# 2025년 11월에 유저 245가 호출한 유니크 API 개수 조회
PFCOUNT 202511:user:245
# 결과: 3
```

#### 3. 데이터 합산
분기별 또는 연도별 데이터를 합산할 수 있습니다.

```redis
# 2025년 11월, 12월 데이터를 합쳐 2025년 전체 통계 생성
PFMERGE 2025:user:245 202511:user:245 202512:user:245

# 2025년 전체 유니크 API 호출 개수 조회
PFCOUNT 2025:user:245
```

### HyperLogLog의 장점

- **공간 효율성**: Set과 비슷한 기능이지만 저장 용량은 **12KB로 고정**
- **확장성**: 수백만 개의 데이터도 고정된 메모리로 처리
- **빠른 성능**: 대용량 데이터를 실시간으로 처리
- **병합 가능**: 여러 기간의 데이터를 쉽게 합산

### 사용 예시

- **API 미터링**: 사용자별 월간/연간 API 호출 수 집계
- **UV(Unique Visitor) 추적**: 일별/월별 순 방문자 수 측정
- **이벤트 추적**: 유니크 이벤트 발생 횟수 측정
- **광고 노출 수 측정**: 유니크 사용자에게 노출된 광고 카운팅

---

## 2. Geospatial Index를 이용한 위치 데이터

### 개요

위치 데이터는 **경도(Longitude)와 위도(Latitude) 좌표 한 쌍**으로 구성됩니다.

### 위치 기반 서비스의 요구사항

사용자 위치의 실시간성을 보장하기 위해서는 신속한 저장과 처리가 필요합니다:

- 사용자의 현재 위치 파악
- 사용자의 이동에 따른 실시간 위치 업데이트
- 사용자의 위치를 기준으로 근처 장소 검색

### Redis Geospatial 자료구조의 장점

- **빠른 저장 및 연산**: 인메모리 기반의 고속 처리
- **실시간 연산 가능**: 위치 기반 실시간 서비스 구현
- **네트워크 트래픽 감소**: Redis 내부에서 계산 처리
- **코드 복잡성 감소**: 간단한 커맨드로 복잡한 지리 연산 수행
- **빠른 응답 속도**: 밀리초 단위의 빠른 응답

### 활용 가능한 서비스 예시

#### 근처 사용자에게 실시간 알림 보내는 서비스
- Geospatial Set과 Pub/Sub 기능을 함께 사용
- 특정 맛집에서 이벤트 발생 시
- 해당 지역 근처의 사용자에게 실시간 알림 전송

#### 배달 서비스
- 주문자 위치 기준 가까운 음식점 검색
- 배달원과 주문자 간 거리 계산

#### 차량 공유 서비스
- 사용자 위치 기준 가까운 차량 검색
- 실시간 차량 위치 추적

### Geospatial 자료구조 사용법

Geospatial은 경도와 위도 쌍으로 구성되며, 내부적으로는 **Sorted Set 구조**로 저장됩니다.

#### 1. 위치 데이터 추가
```redis
# 형식: GEOADD <key> <경도> <위도> <member>
# 주의: 경도(longitude)가 먼저, 위도(latitude)가 나중

# 서울 강남역 위치 추가
GEOADD locations 127.0276 37.4979 "강남역"

# 여러 위치 동시 추가
GEOADD locations 126.9780 37.5665 "서울역" 129.0756 35.1796 "부산역"
```

#### 2. 저장된 위치 정보 조회
```redis
# Key와 Member로 경도/위도 조회
GEOPOS locations "강남역"
# 결과: 127.0276, 37.4979
```

#### 3. 두 지점 간 거리 계산
```redis
# 단위: m(미터), km(킬로미터), ft(피트), mi(마일)
GEODIST locations "강남역" "서울역" km
# 결과: 약 6.5 (km)
```

#### 4. 특정 위치 기준 주변 검색

**GEOSEARCH 커맨드 형식:**
```
GEOSEARCH key FROMLONLAT|FROMMEMBER <좌표 또는 멤버>
          BYRADIUS|BYBOX <범위> <단위>
          [WITHDIST] [WITHCOORD] [COUNT n]
```

**옵션 설명:**
- `FROMLONLAT`: 직접 경도와 위도를 지정하여 검색 중심점 설정
- `FROMMEMBER`: 저장된 Member를 중심으로 검색
- `BYRADIUS`: 원형 범위 검색 (반지름 지정, 단위: km, m, ft, mi)
- `BYBOX`: 직사각형 범위 검색 (너비와 높이 지정)

**예시 1: Member를 중심으로 반경 내 검색 (원형)**
```redis
# 강남역 기준 반경 10km 내의 장소 검색
GEOSEARCH locations FROMMEMBER "강남역" BYRADIUS 10 km WITHDIST

# COUNT 옵션으로 결과 개수 제한
GEOSEARCH locations FROMMEMBER "강남역" BYRADIUS 10 km COUNT 5
```

**예시 2: 직접 좌표로 검색**
```redis
# 특정 좌표(127.0, 37.5) 기준 반경 5km 내 검색
GEOSEARCH locations FROMLONLAT 127.0 37.5 BYRADIUS 5 km WITHDIST WITHCOORD
```

**예시 3: 직사각형 범위 검색**
```redis
# 강남역 기준 너비 10km, 높이 15km 직사각형 범위 내 검색
GEOSEARCH locations FROMMEMBER "강남역" BYBOX 10 15 km
```

**옵션 플래그:**
- `WITHDIST`: 거리 정보 포함
- `WITHCOORD`: 좌표 정보 포함
- `WITHHASH`: Geohash 값 포함
- `COUNT n`: 최대 n개 결과만 반환
- `ASC|DESC`: 거리순 정렬 (오름차순/내림차순)

#### 5. 위치 데이터 삭제
```redis
# Geospatial은 내부적으로 Sorted Set이므로 ZREM 사용
ZREM locations "강남역"
```

### 활용 예시
- 배달의민족, 우버이츠 등 배달 서비스
- 카카오택시, 우버 등 차량 공유 서비스
- 근처 가게/음식점 검색
- 실시간 위치 기반 알림

---

## 시리즈 전체 정리

Redis의 각 자료구조는 특정 사용 사례에 최적화되어 있습니다:

### Part 1: Sorted Set
- **리더보드**: 자동 정렬로 랭킹 시스템 구현
- **최근 검색 기록**: 타임스탬프 기반 자동 정렬 및 중복 제거

### Part 2: Set
- **태그 기능**: 집합 연산으로 복잡한 태그 검색
- **좋아요 처리**: 중복 자동 제거
- **랜덤 데이터**: RDBMS 대비 월등한 랜덤 추출 성능

### Part 3: Hash & Bitmap
- **읽지 않은 메시지**: 채널별 독립적 카운트 관리
- **DAU 측정**: 극도로 적은 메모리로 대규모 사용자 추적

### Part 4: HyperLogLog & Geospatial
- **애플리케이션 미터링**: 고정된 12KB 메모리로 무제한 유니크 카운팅
- **위치 데이터**: 실시간 위치 기반 서비스 구현

---

## 마치며

적절한 자료구조를 선택하면 메모리 효율성과 성능을 동시에 확보할 수 있습니다. Redis는 각 자료구조별로 특화된 커맨드를 제공하여, 복잡한 로직을 간단하게 구현할 수 있도록 돕습니다.

실무에서는 요구사항을 분석하고, 각 자료구조의 특성을 이해하여 최적의 선택을 하는 것이 중요합니다.

---

> **시리즈 완결!** Redis 자료구조 활용사례 시리즈를 읽어주셔서 감사합니다.
