---
aliases:
  - 자료구조 활용사례
  - hyperloglog 활용사례
tags:
  - redis
  - hyperloglog
  - 미터링
  - 모니터링
  - apm
---
## HyperLogLog를 이용한 애플리케이션 미터링

### 미터링이란?

**미터링(Metering)**: 사용량을 정량적으로 측정하고 기록하는 것

즉, 사용자가 얼마나 서비스를 사용했는지 정확하게 측정하는 방법입니다.

### 요구사항

미터링 솔루션은 사용자의 서비스 사용 내역을 처리하기 때문에:
- 대용량 데이터 처리 능력 필요
- 높은 처리량(High Throughput)
- 낮은 대기 시간(Low Latency)

### HyperLogLog 사용 조건

다음 조건을 만족할 때 HyperLogLog 사용을 고려할 수 있습니다:
- 집합 내의 유일한 데이터의 개수만 카운팅하면 됨
- 1% 미만의 오차는 허용 가능
- 카운팅할 때 사용한 정확한 데이터를 다시 확인할 필요 없음

### 일반적인 방법 vs HyperLogLog

#### 일반적인 방법 (Set 사용)
- 중복을 피하기 위해 저장된 데이터를 모두 메모리에 보관
- 데이터가 많아질수록 메모리 사용량 급증

#### HyperLogLog 방법
- 저장된 데이터를 다시 확인할 필요가 없다면 최소한의 메모리만 사용
- 중복되지 않는 데이터의 개수를 효율적으로 계산 가능
- **고정된 메모리 사용량: 최대 12KB**

### 사용 방법

#### 1. API 호출 기록 추가
2025년 11월에 ID가 245인 유저의 API 호출을 추적하려면, API를 호출할 때마다 `PFADD` 커맨드를 이용해 로그 식별자를 저장합니다.

```redis
# 유저 245가 API 호출 (로그 식별자: 29583)
PFADD 202511:user:245 29583

# 같은 유저의 또 다른 API 호출 (로그 식별자: 29584, 29585)
PFADD 202511:user:245 29584 29585

# 중복된 호출은 카운트되지 않음
PFADD 202511:user:245 29583
```

#### 2. 유니크 API 호출 개수 조회
```redis
# 2025년 11월에 유저 245가 호출한 유니크 API 개수 조회
PFCOUNT 202511:user:245
# 결과: 3
```

#### 3. 데이터 합산
분기별 또는 연도별 데이터를 합산할 수 있습니다.

```redis
# 2025년 11월, 12월 데이터를 합쳐 2025년 전체 통계 생성
PFMERGE 2025:user:245 202511:user:245 202512:user:245

# 2025년 전체 유니크 API 호출 개수 조회
PFCOUNT 2025:user:245
```

### HyperLogLog의 장점

- **공간 효율성**: Set과 비슷한 기능이지만 저장 용량은 **12KB로 고정**
- **확장성**: 수백만 개의 데이터도 고정된 메모리로 처리
- **빠른 성능**: 대용량 데이터를 실시간으로 처리
- **병합 가능**: 여러 기간의 데이터를 쉽게 합산

### 사용 예시

**API 미터링**: 사용자별 월간/연간 API 호출 수 집계
**UV(Unique Visitor) 추적**: 일별/월별 순 방문자 수 측정
**이벤트 추적**: 유니크 이벤트 발생 횟수 측정


