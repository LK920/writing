---
aliases:
  - 위치 기반 애플리케이션
tags:
  - redis
  - geospatial
  - 위치
---
## Geospatial Index를 이용한 위치 데이터

### 위치 데이터란?

위치 데이터는 **경도(Longitude)와 위도(Latitude) 좌표 한 쌍**으로 구성됩니다.

### 위치 기반 서비스의 요구사항

사용자 위치의 실시간성을 보장하기 위해서는 신속한 저장과 처리가 필요합니다:

- 사용자의 현재 위치 파악
- 사용자의 이동에 따른 실시간 위치 업데이트
- 사용자의 위치를 기준으로 근처 장소 검색

### Redis Geospatial 자료구조의 장점

- **빠른 저장 및 연산**: 인메모리 기반의 고속 처리
- **실시간 연산 가능**: 위치 기반 실시간 서비스 구현
- **네트워크 트래픽 감소**: Redis 내부에서 계산 처리
- **코드 복잡성 감소**: 간단한 커맨드로 복잡한 지리 연산 수행
- **빠른 응답 속도**: 밀리초 단위의 빠른 응답

### 활용 가능한 서비스 예시

#### 근처 사용자에게 실시간 알림 보내는 서비스
- Geospatial Set과 Pub/Sub 기능을 함께 사용
- 특정 맛집에서 이벤트 발생 시
- 해당 지역 근처의 사용자에게 실시간 알림 전송

#### 배달 서비스
- 주문자 위치 기준 가까운 음식점 검색
- 배달원과 주문자 간 거리 계산

#### 차량 공유 서비스
- 사용자 위치 기준 가까운 차량 검색
- 실시간 차량 위치 추적

### Geospatial 자료구조 사용법

Geospatial은 경도와 위도 쌍으로 구성되며, 내부적으로는 **Sorted Set 구조**로 저장됩니다.

#### 1. 위치 데이터 추가
```redis
# 형식: GEOADD <key> <경도> <위도> <member>
# 주의: 경도(longitude)가 먼저, 위도(latitude)가 나중

# 서울 강남역 위치 추가
GEOADD locations 127.0276 37.4979 "강남역"

# 여러 위치 동시 추가
GEOADD locations 126.9780 37.5665 "서울역" 129.0756 35.1796 "부산역"
```

#### 2. 저장된 위치 정보 조회
```redis
# Key와 Member로 경도/위도 조회
GEOPOS locations "강남역"
# 결과: 127.0276, 37.4979
```

#### 3. 두 지점 간 거리 계산
```redis
# 단위: m(미터), km(킬로미터), ft(피트), mi(마일)
GEODIST locations "강남역" "서울역" km
# 결과: 약 6.5 (km)
```

#### 4. 특정 위치 기준 주변 검색

**GEOSEARCH 커맨드 형식:**
```
GEOSEARCH key FROMLONLAT|FROMMEMBER <좌표 또는 멤버>
          BYRADIUS|BYBOX <범위> <단위>
          [WITHDIST] [WITHCOORD] [COUNT n]
```

**옵션 설명:**
- `FROMLONLAT`: 직접 경도와 위도를 지정하여 검색 중심점 설정
- `FROMMEMBER`: 저장된 Member를 중심으로 검색
- `BYRADIUS`: 원형 범위 검색 (반지름 지정, 단위: km, m, ft, mi)
- `BYBOX`: 직사각형 범위 검색 (너비와 높이 지정)

**예시 1: Member를 중심으로 반경 내 검색 (원형)**
```redis
# 강남역 기준 반경 10km 내의 장소 검색
GEOSEARCH locations FROMMEMBER "강남역" BYRADIUS 10 km WITHDIST

# COUNT 옵션으로 결과 개수 제한
GEOSEARCH locations FROMMEMBER "강남역" BYRADIUS 10 km COUNT 5
```

**예시 2: 직접 좌표로 검색**
```redis
# 특정 좌표(127.0, 37.5) 기준 반경 5km 내 검색
GEOSEARCH locations FROMLONLAT 127.0 37.5 BYRADIUS 5 km WITHDIST WITHCOORD
```

**예시 3: 직사각형 범위 검색**
```redis
# 강남역 기준 너비 10km, 높이 15km 직사각형 범위 내 검색
GEOSEARCH locations FROMMEMBER "강남역" BYBOX 10 15 km
```

**옵션 플래그:**
- `WITHDIST`: 거리 정보 포함
- `WITHCOORD`: 좌표 정보 포함
- `WITHHASH`: Geohash 값 포함
- `COUNT n`: 최대 n개 결과만 반환
- `ASC|DESC`: 거리순 정렬 (오름차순/내림차순)

#### 5. 위치 데이터 삭제
```redis
# Geospatial은 내부적으로 Sorted Set이므로 ZREM 사용
ZREM locations "강남역"
```