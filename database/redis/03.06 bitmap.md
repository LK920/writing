---
aliases:
  - 레디스_기본_개념
  - 레디스_bitmap
tags:
  - 레디스
  - redis
  - 레디스기본개념
  - 레디스자료구조
  - bitmap
---
# Redis Bitmap 자료구조

## 기본 개요

**String 자료구조에 비트 연산 기능을 더한 특화된 형태**입니다. 독자적인 자료구조가 아니라, String의 진화된 활용법입니다.

- **본질**: String 저장 + 비트 레벨 연산
- **저장 공간**: String의 512MB 제한 → 최대 **2^32개의 비트** 저장 가능
- **핵심 장점**: **공간 효율성 극대화**
- **활용**: 활성 사용자 추적, 방문 기록, 권한 관리, 온라인 상태 등

---

## 공간 효율성 비교

### 시나리오: 40억 사용자의 일일 활성 여부 저장 (Y/N)

**방법 1: String으로 저장 (비효율)**

```
SET active:2025-01-15:user:1 "true"
SET active:2025-01-15:user:2 "false"
SET active:2025-01-15:user:3 "true"
... (40억 번)

각 데이터: 약 30-50바이트
필요 메모리: 40억 × 40바이트 = 약 160GB 이상 😱
```

**방법 2: Bitmap 사용 (효율적) ✅**

```
SETBIT active:2025-01-15 1 1
SETBIT active:2025-01-15 2 0
SETBIT active:2025-01-15 3 1
... (40억 번)

계산: 40억 비트 ÷ 8 = 500MB
필요 메모리: 약 512MB 

차이: 약 320배 메모리 절감!
```

### 메모리 계산 공식

```
필요한 비트 수: N
필요한 메모리: ⌈N ÷ 8⌉ 바이트

예시:
- 1000명 Y/N: 1000 ÷ 8 = 125 바이트
- 1백만명 Y/N: 1,000,000 ÷ 8 = 125 KB
- 10억명 Y/N: 1,000,000,000 ÷ 8 = 125 MB
```

---

## 비트맵의 동작 원리

### 저장 구조

```
Key: "active:2025-01-15"
Value (메모리에 저장): 
  [byte 0]  [byte 1]  [byte 2]  ...
  01010011  11001101  01110010  ...
  ↑ offset ↑ offset ↑
  0-7      8-15     16-23
```

**offset = 123인 비트 저장:**

```
byte 위치 = 123 ÷ 8 = byte 15
비트 위치 = 123 % 8 = bit 3 (byte 내)
```

### 구체적 예제: 일일 로그인 기록

```
상황: 2025-01-15에 누가 로그인했나?

SETBIT login:2025-01-15 100 1    // 사용자 ID 100: 로그인함
SETBIT login:2025-01-15 200 0    // 사용자 ID 200: 로그인 안 함
SETBIT login:2025-01-15 300 1    // 사용자 ID 300: 로그인함
SETBIT login:2025-01-15 400 1    // 사용자 ID 400: 로그인함

Redis 메모리 (실제 저장):
"login:2025-01-15" → [10110010000...]
                      ↑ offset 0-3은 0
                      ↑ offset 100 = 1
                      ↑ offset 200 = 0
                      ↑ offset 300 = 1
                      ↑ offset 400 = 1
```

---

## 핵심 커맨드

### 개별 비트 조작

```
SETBIT key offset value           // 특정 offset의 비트를 0 또는 1로 설정
GETBIT key offset                 // 특정 offset의 비트값 조회
BITCOUNT key [start end]          // 비트값이 1인 개수 세기
```

**예시: 1000명 사용자의 로그인 현황**

```
일반 String 방법 (비효율):
SET user:100:login:2025-01-15 "true"     (약 30바이트)
SET user:200:login:2025-01-15 "true"     (약 30바이트)
SET user:300:login:2025-01-15 "true"     (약 30바이트)
SET user:400:login:2025-01-15 "true"     (약 30바이트)
... 1000명
필요 메모리: 약 30KB

Bitmap 방법 (효율적):
SETBIT login:2025-01-15 100 1    // 사용자 100 로그인
SETBIT login:2025-01-15 200 1    // 사용자 200 로그인
SETBIT login:2025-01-15 300 1    // 사용자 300 로그인
SETBIT login:2025-01-15 400 1    // 사용자 400 로그인
... 1000명
필요 메모리: 약 125바이트 (1000 ÷ 8)

차이: 약 240배 메모리 절감! ✅
```

**조회 예시:**

```
GETBIT login:2025-01-15 100      // 1 (로그인했음)
GETBIT login:2025-01-15 200      // 1 (로그인했음)
GETBIT login:2025-01-15 999      // 0 (로그인 안 했음)

BITCOUNT login:2025-01-15        // 3 (총 3명 로그인)
→ 오늘 로그인한 사용자 수!
```

### 여러 비트 한번에 조작 (BITFIELD)

```
BITFIELD key [GET type offset] [SET type offset value] [INCRBY type offset increment]
```

여러 비트를 한 번의 명령으로 조작할 수 있습니다.

**예시: 부호 있는 정수로 저장**

```
BITFIELD counter SET u8 0 100     // offset 0에 unsigned 8-bit 정수 100 저장
BITFIELD counter GET u8 0         // 값 조회
BITFIELD counter INCRBY u8 0 10   // 10씩 증가
```

### 집합 연산 (비트 연산)

```
BITOP AND dest key1 key2 ...      // AND 연산 결과를 dest에 저장
BITOP OR dest key1 key2 ...       // OR 연산
BITOP XOR dest key1 key2 ...      // XOR 연산
BITOP NOT dest key                // NOT 연산
```

**예시 1: 두 날짜 모두 활성인 사용자**

```
SETBIT active:2025-01-14 100 1
SETBIT active:2025-01-15 100 1

BITOP AND active:both active:2025-01-14 active:2025-01-15
BITCOUNT active:both              // 결과: 1 (사용자 100은 양일 모두 활성)
```

**예시 2: 요일별 접속 패턴**

```
월요일 접속한 사용자:
SETBIT weekday:monday 100 1       // 사용자 100 접속
SETBIT weekday:monday 200 1       // 사용자 200 접속
SETBIT weekday:monday 300 0       // 사용자 300 미접속

화요일 접속한 사용자:
SETBIT weekday:tuesday 100 1      // 사용자 100 접속
SETBIT weekday:tuesday 200 0      // 사용자 200 미접속
SETBIT weekday:tuesday 300 1      // 사용자 300 접속

질문 1: 월요일과 화요일 모두 접속한 사용자?
BITOP AND weekday:both weekday:monday weekday:tuesday
BITCOUNT weekday:both             // 결과: 1 (사용자 100만)

질문 2: 월요일 또는 화요일에 접속한 사용자?
BITOP OR weekday:either weekday:monday weekday:tuesday
BITCOUNT weekday:either           // 결과: 3 (사용자 100, 200, 300 모두)
```

### 비트 위치 검색

```
BITPOS key bit [start end]        // 특정 비트값(0 또는 1)의 첫 위치 찾기
```

**예시:**

```
BITPOS login:2025-01-15 1         // 첫 로그인한 사용자의 ID
```

---

## 시간 복잡도

|작업|시간복잡도|설명|
|---|---|---|
|SETBIT / GETBIT|**O(1)**|매우 빠름|
|BITCOUNT|**O(N)**|비트 개수에 따라|
|BITOP|**O(N)**|비트맵 크기에 따라|
|BITPOS|**O(N)**|최악의 경우 전체 탐색|

---

## 실무 활용 패턴

### 1️⃣ 일일 활성 사용자 추적 (DAU)

```
// 2025-01-15에 사용자 1234가 로그인
SETBIT dau:2025-01-15 1234 1

// 해당 날짜 활성 사용자 수
BITCOUNT dau:2025-01-15
→ 결과: 오늘 로그인한 총 사용자 수

// 7일간 활성한 사용자 중복 제거 (합집합)
BITOP OR dau:week dau:2025-01-09 dau:2025-01-10 ... dau:2025-01-15
BITCOUNT dau:week
→ 결과: 지난주에 최소 1번 이상 로그인한 사용자 수

// 7일 모두 활성한 사용자 (교집합)
BITOP AND dau:all-days dau:2025-01-09 dau:2025-01-10 ... dau:2025-01-15
BITCOUNT dau:all-days
→ 결과: 지난주 매일 로그인한 사용자 수 (VIP 사용자 추출)
```

### 2️⃣ 사용자 권한 관리

```
// 권한 비트 위치 정의
// bit 0 = 읽기, bit 1 = 쓰기, bit 2 = 삭제

SETBIT user:123:permissions 0 1   // 읽기 권한 부여
SETBIT user:123:permissions 1 1   // 쓰기 권한 부여

GETBIT user:123:permissions 2     // 0 (삭제 권한 없음)
```

### 3️⃣ 온라인 상태 추적

```
// 리얼타임 온라인 사용자
SETBIT online:users `timestamp` 1

// 현재 온라인 사용자 수
BITCOUNT online:users
```

### 4️⃣ 멤버십 관리 (어떤 기능에 접근했는가)

```
// 사용자 ID 100이 어떤 기능들을 사용했나?
SETBIT user:100:features:used 0 1  // 기능 0 사용함
SETBIT user:100:features:used 5 1  // 기능 5 사용함
SETBIT user:100:features:used 10 1 // 기능 10 사용함

// 5번 기능 사용했는지 확인
GETBIT user:100:features:used 5    // 1
```

---

## 주의사항

### ⚠️ 피해야 할 것

1. **매우 적은 데이터에 사용**: Set이나 List가 더 나을 수 있음
2. **실시간성이 중요한 복잡한 쿼리**: 전제 탐색(O(N))이 필요할 때
3. **설명 없이 사용**: 비트 offset의 의미가 명확해야 함

### ✅ 활용하기 좋은 상황

1. **대규모 이진 데이터** (활성/비활성, 참/거짓)
2. **공간 효율성이 중요함** (수억 건 이상)
3. **간단한 yes/no 데이터**
4. **집합 연산 필요** (공통 데이터 추출)

---

## 메모리 계산 팁

```
필요한 비트 수: N
필요한 메모리: ⌈N ÷ 8⌉ 바이트

예: 10억 사용자 Y/N 데이터
10억 ÷ 8 = 125MB
```

---

## 실무 활용 예상

|상황|커맨드|
|---|---|
|일일 활성 사용자|SETBIT dau:2025-01-15 user_id 1|
|특정 날짜 활성 사용자 수|BITCOUNT dau:2025-01-15|
|7일 활성 사용자 (합집합)|BITOP OR dau:week dau:2025-01-09 ...|
|모든 날짜 활성 (교집합)|BITOP AND dau:all dau:2025-01-09 ...|
|권한 확인|GETBIT user:123:permissions 0|