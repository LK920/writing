# Redis 백업 개념 정리

## 1. RDB (Redis Database) - 스냅샷 방식

### 개념
특정 시점의 Redis 데이터를 **통째로 사진 찍듯이** 저장하는 방식

```
Redis 메모리 (10GB)
    ↓
[스냅샷 촬영]
    ↓
dump.rdb 파일 (10GB)
```

### 동작 방식
```bash
# 수동 백업
redis-cli SAVE      # 동기 방식 (서비스 중단됨)
redis-cli BGSAVE    # 비동기 방식 (백그라운드, COW 사용)

# 자동 백업 (redis.conf)
save 900 1      # 15분 동안 1개 이상 변경 시
save 300 10     # 5분 동안 10개 이상 변경 시
save 60 10000   # 1분 동안 10000개 이상 변경 시
```

### 파일 저장 위치
```bash
# 기본: Redis 실행 디렉토리
dump.rdb

# Homebrew 설치 시 일반적 경로
/opt/homebrew/var/db/redis/dump.rdb
```

### 장점
- ✅ **파일 크기 작음** (압축됨)
- ✅ **복구 속도 빠름** (파일 하나만 로드)
- ✅ **성능 영향 적음** (백그라운드 실행)
- ✅ **백업 파일 관리 쉬움** (하나의 파일)

### 단점
- ❌ **데이터 손실 가능** (마지막 백업 이후 데이터 유실)
- ❌ **대용량 데이터 시 fork 비용** (COW로 메모리 추가 사용)
- ❌ **백업 주기 제한** (너무 자주 하면 성능 저하)

### 사용 시나리오
- 데이터 손실 몇 분~몇 시간 허용 가능
- 정기적 백업이면 충분한 경우
- 디스크 공간 제한적인 환경

---

## 2. AOF (Append Only File) - 명령어 로그 방식

### 개념
Redis가 받은 **모든 쓰기 명령어를 일기처럼** 기록하는 방식

```
SET key1 "hello"  → appendonly.aof 파일에 기록
SET key2 "world"  → 추가 기록
DEL key1          → 추가 기록
...
```

### 동작 방식
```bash
# redis.conf
appendonly yes                    # AOF 활성화
appendfilename "appendonly.aof"   # 파일명
appendfsync everysec              # 동기화 주기

# appendfsync 옵션:
# - always: 명령마다 즉시 (가장 안전, 느림)
# - everysec: 1초마다 (권장)
# - no: OS에 맡김 (가장 빠름, 위험)
```

### AOF 재작성 (Rewrite)
```bash
# 수동 재작성
redis-cli BGREWRITEAOF

# 자동 재작성 (redis.conf)
auto-aof-rewrite-percentage 100   # 100% 증가 시
auto-aof-rewrite-min-size 64mb    # 최소 64MB 이상일 때
```

**왜 재작성이 필요한가?**
```
[재작성 전 - 비효율적]
SET key1 "a"
SET key1 "b"
SET key1 "c"
DEL key1
SET key1 "d"

[재작성 후 - 최적화]
SET key1 "d"
```

### 장점
- ✅ **데이터 손실 최소화** (1초 단위 또는 실시간)
- ✅ **복구 시 정확성** (모든 명령 재실행)
- ✅ **로그 파일 손상 시 복구 도구** 제공

### 단점
- ❌ **파일 크기 큼** (압축 전)
- ❌ **복구 속도 느림** (모든 명령 재실행)
- ❌ **쓰기 성능 영향** (디스크 I/O)
- ❌ **재작성 시 리소스 사용** (COW 메모리)

### 사용 시나리오
- 데이터 손실 절대 불가능
- 금융, 결제 등 중요한 데이터
- 복구 시간보다 정확성이 중요

---

## 3. COW (Copy-on-Write) - 백업 메커니즘

### 개념
백그라운드 백업 시 **"수정되는 데이터만 복사"**하는 메모리 절약 기법

### COW가 사용되는 시점
```bash
BGSAVE              # RDB 백업 시
BGREWRITEAOF        # AOF 재작성 시
```

**일반 쓰기에는 COW를 사용하지 않습니다!**

---

### 동작 과정

#### 1️⃣ fork() 시작 - 프로세스 복제

```
부모 프로세스 (Redis 서버)
├─ 메모리: 10GB
└─ 역할: 클라이언트 요청 처리

      fork()
        ↓

자식 프로세스 (백업 담당)
├─ 메모리: 10GB (같은 메모리 가리킴!)
└─ 역할: 디스크에 백업

실제 메모리 사용: 10GB (20GB 아님!)
```

#### 2️⃣ 데이터 수정 시 - 복사 발생

```
T1: 클라이언트가 key1 수정
    ↓
부모: key1을 새 메모리에 복사 → 수정 (key1_new)
자식: 원본 key1 계속 사용 (key1_old, 백업용)

추가 메모리: key1 크기만큼만!
```

#### 3️⃣ 백업 완료 - 정리

```
자식 프로세스 종료
    ↓
key1_old, key2_old 등 옛날 데이터 삭제
    ↓
부모만 남음: key1_new, key2_new 사용
```

---

### 메모리 사용 예시

```
[시나리오 1: 쓰기가 적을 때]
원본: 10GB
백업 중 수정: 100MB (1%)
실제 메모리: 10.1GB ✅ 효율적!

[시나리오 2: 쓰기가 많을 때]
원본: 10GB
백업 중 수정: 5GB (50%)
실제 메모리: 15GB ⚠️ 메모리 부족 위험!
```

---

### 시각적 정리

```
[백업 시작]
┌─────────────────────┐
│  메모리 10GB         │
│  key1 | key2 | key3  │
└─────────────────────┘
   ↑         ↑
   │         │
부모(Redis) 자식(백업)
같은 메모리 공유!

[key1 수정 시]
┌─────────────────────┐
│ key1_old ← 자식만    │
│ key2 ← 둘 다 공유    │
│ key3 ← 둘 다 공유    │
└─────────────────────┘
┌──────────┐
│ key1_new │ ← 부모만
└──────────┘

[백업 완료]
┌─────────────────────┐
│ key1_new             │
│ key2                 │
│ key3                 │
└─────────────────────┘
(old 버전 삭제됨!)
```

---

## 비교표

| 항목 | RDB | AOF | COW |
|------|-----|-----|-----|
| **종류** | 백업 방식 | 백업 방식 | 백업 메커니즘 |
| **기본 활성화** | ✅ Yes | ❌ No | N/A |
| **파일** | dump.rdb | appendonly.aof | - |
| **데이터 손실** | 마지막 백업 이후 | 최대 1초 | - |
| **파일 크기** | 작음 | 큼 | - |
| **복구 속도** | 빠름 | 느림 | - |
| **메모리 사용** | COW 사용 | COW 사용 | 메모리 절약 |
| **사용 시점** | 주기적 | 실시간 | BGSAVE/BGREWRITEAOF |

---

## 권장 설정

### 개발/학습 환경
```bash
# RDB만 사용 (기본값)
save 900 1
appendonly no
```

### 프로덕션 환경 (데이터 중요)
```bash
# RDB + AOF 함께 사용
save 900 1
appendonly yes
appendfsync everysec
```

### 복구 우선순위
```
Redis 재시작 시:
1. AOF 파일 있으면 → AOF로 복구 (우선)
2. AOF 없으면 → RDB로 복구
3. 둘 다 없으면 → 빈 상태로 시작
```

---

## 핵심 요약

### RDB
📸 **스냅샷 방식** - 특정 시점 전체 저장, 빠르고 작지만 데이터 손실 가능

### AOF  
📝 **로그 방식** - 모든 명령 기록, 안전하지만 크고 느림

### COW
🧠 **메모리 기법** - 백그라운드 백업 시 수정된 부분만 복사, 메모리 효율적

**3가지 모두 Redis 데이터 보존을 위한 서로 다른 역할!**

---

## 추가 학습 자료

### 확인 명령어
```bash
# 현재 백업 설정 확인
redis-cli CONFIG GET save
redis-cli CONFIG GET appendonly

# 백업 정보 확인
redis-cli INFO persistence

# 수동 백업 실행
redis-cli BGSAVE
redis-cli BGREWRITEAOF
```

### 파일 디스크립터 관련
```bash
# 파일 디스크립터 확인
ulimit -n

# 변경 (현재 세션만)
ulimit -n 10032

# Redis 연결 테스트
redis-benchmark -c 289 -n 1000 -q
```

---

**작성일:** 2025년 10월 12일  
**버전:** 1.0